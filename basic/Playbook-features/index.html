<!doctype html><html lang=zh class=no-js> <head><meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1"><meta name=description content=ansible,wiki,ops,devops,auto,运维自动化><link href=https://ansible.leops.cn/basic/Playbook-features/ rel=canonical><meta name=author content=lework><link rel="shortcut icon" href=../../assets/images/favicon.png><meta name=generator content="mkdocs-1.1.2, mkdocs-material-6.1.5"><title>15. Playbook 高级特性 - Ansible wiki</title><link rel=stylesheet href=../../assets/stylesheets/main.21aed14c.min.css><link rel=stylesheet href=../../assets/stylesheets/palette.196e0c26.min.css><meta name=theme-color content=#4051b5><link href=https://fonts.gstatic.com rel=preconnect crossorigin><link rel=stylesheet href="https://fonts.googleapis.com/css?family=Roboto:300,400,400i,700%7CRoboto+Mono&display=fallback"><style>body,input{font-family:"Roboto",-apple-system,BlinkMacSystemFont,Helvetica,Arial,sans-serif}code,kbd,pre{font-family:"Roboto Mono",SFMono-Regular,Consolas,Menlo,monospace}</style></head> <body dir=ltr data-md-color-scheme=default data-md-color-primary=indigo data-md-color-accent=indigo> <input class=md-toggle data-md-toggle=drawer type=checkbox id=__drawer autocomplete=off> <input class=md-toggle data-md-toggle=search type=checkbox id=__search autocomplete=off> <label class=md-overlay for=__drawer></label> <div data-md-component=skip> <a href=#15-playbook class=md-skip> 跳转至 </a> </div> <div data-md-component=announce> </div> <header class=md-header data-md-component=header> <nav class="md-header-nav md-grid" aria-label=Header> <a href=https://ansible.leops.cn title="Ansible wiki" class="md-header-nav__button md-logo" aria-label="Ansible wiki"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg> </a> <label class="md-header-nav__button md-icon" for=__drawer> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M3 6h18v2H3V6m0 5h18v2H3v-2m0 5h18v2H3v-2z"/></svg> </label> <div class=md-header-nav__title data-md-component=header-title> <div class=md-header-nav__ellipsis> <span class="md-header-nav__topic md-ellipsis"> Ansible wiki </span> <span class="md-header-nav__topic md-ellipsis"> 15. Playbook 高级特性 </span> </div> </div> <label class="md-header-nav__button md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> </label> <div class=md-search data-md-component=search role=dialog> <label class=md-search__overlay for=__search></label> <div class=md-search__inner role=search> <form class=md-search__form name=search> <input type=text class=md-search__input name=query aria-label=搜索 placeholder=搜索 autocapitalize=off autocorrect=off autocomplete=off spellcheck=false data-md-component=search-query data-md-state=active required> <label class="md-search__icon md-icon" for=__search> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M9.5 3A6.5 6.5 0 0116 9.5c0 1.61-.59 3.09-1.56 4.23l.27.27h.79l5 5-1.5 1.5-5-5v-.79l-.27-.27A6.516 6.516 0 019.5 16 6.5 6.5 0 013 9.5 6.5 6.5 0 019.5 3m0 2C7 5 5 7 5 9.5S7 14 9.5 14 14 12 14 9.5 12 5 9.5 5z"/></svg> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </label> <button type=reset class="md-search__icon md-icon" aria-label=Clear data-md-component=search-reset tabindex=-1> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M19 6.41L17.59 5 12 10.59 6.41 5 5 6.41 10.59 12 5 17.59 6.41 19 12 13.41 17.59 19 19 17.59 13.41 12 19 6.41z"/></svg> </button> </form> <div class=md-search__output> <div class=md-search__scrollwrap data-md-scrollfix> <div class=md-search-result data-md-component=search-result> <div class=md-search-result__meta> 正在初始化搜索引擎 </div> <ol class=md-search-result__list></ol> </div> </div> </div> </div> </div> <div class=md-header-nav__source> <a href=https://github.com/leops-china/ansible-wiki/ title="前往 GitHub 仓库" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg> </div> <div class=md-source__repository> leops-china/ansible-wiki </div> </a> </div> </nav> </header> <div class=md-container data-md-component=container> <nav class="md-tabs md-tabs--active" aria-label=Tabs data-md-component=tabs> <div class="md-tabs__inner md-grid"> <ul class=md-tabs__list> <li class=md-tabs__item> <a href=../.. class=md-tabs__link> Home </a> </li> <li class=md-tabs__item> <a href=../Introduction/ class="md-tabs__link md-tabs__link--active"> Ansible 入门 </a> </li> <li class=md-tabs__item> <a href=../../advanced/optimization/ class=md-tabs__link> Ansible 进阶 </a> </li> <li class=md-tabs__item> <a href=../../dev/ class=md-tabs__link> Ansible 开发 </a> </li> <li class=md-tabs__item> <a href=../../ui/ class=md-tabs__link> Ansible UI </a> </li> <li class=md-tabs__item> <a href=../../certification/ class=md-tabs__link> Ansible 认证 </a> </li> <li class=md-tabs__item> <a href=../../roles/ class=md-tabs__link> Ansible Roles </a> </li> </ul> </div> </nav> <main class=md-main data-md-component=main> <div class="md-main__inner md-grid"> <div class="md-sidebar md-sidebar--primary" data-md-component=navigation> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--primary" aria-label=Navigation data-md-level=0> <label class=md-nav__title for=__drawer> <a href=https://ansible.leops.cn title="Ansible wiki" class="md-nav__button md-logo" aria-label="Ansible wiki"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M12 8a3 3 0 003-3 3 3 0 00-3-3 3 3 0 00-3 3 3 3 0 003 3m0 3.54C9.64 9.35 6.5 8 3 8v11c3.5 0 6.64 1.35 9 3.54 2.36-2.19 5.5-3.54 9-3.54V8c-3.5 0-6.64 1.35-9 3.54z"/></svg> </a> Ansible wiki </label> <div class=md-nav__source> <a href=https://github.com/leops-china/ansible-wiki/ title="前往 GitHub 仓库" class=md-source> <div class="md-source__icon md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 448 512"><path d="M439.55 236.05L244 40.45a28.87 28.87 0 00-40.81 0l-40.66 40.63 51.52 51.52c27.06-9.14 52.68 16.77 43.39 43.68l49.66 49.66c34.23-11.8 61.18 31 35.47 56.69-26.49 26.49-70.21-2.87-56-37.34L240.22 199v121.85c25.3 12.54 22.26 41.85 9.08 55a34.34 34.34 0 01-48.55 0c-17.57-17.6-11.07-46.91 11.25-56v-123c-20.8-8.51-24.6-30.74-18.64-45L142.57 101 8.45 235.14a28.86 28.86 0 000 40.81l195.61 195.6a28.86 28.86 0 0040.8 0l194.69-194.69a28.86 28.86 0 000-40.81z"/></svg> </div> <div class=md-source__repository> leops-china/ansible-wiki </div> </a> </div> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../.. class=md-nav__link> Home </a> </li> <li class=md-nav__item> <a href=../../resources/ class=md-nav__link> Ansible 资源 </a> </li> <li class=md-nav__item> <a href=../../appreciate/ class=md-nav__link> 赞赏支持 </a> </li> <li class="md-nav__item md-nav__item--active md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4 type=checkbox id=nav-4 checked> <label class=md-nav__link for=nav-4> Ansible 入门 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Ansible 入门" data-md-level=1> <label class=md-nav__title for=nav-4> <span class="md-nav__icon md-icon"></span> Ansible 入门 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Introduction/ class=md-nav__link> 1. Ansible 介绍 </a> </li> <li class=md-nav__item> <a href=../Installation/ class=md-nav__link> 2. 安装 Ansible </a> </li> <li class=md-nav__item> <a href=../Quickstart/ class=md-nav__link> 3. 快速开始 </a> </li> <li class=md-nav__item> <a href=../Inventory/ class=md-nav__link> 4. 认识主机清单 </a> </li> <li class=md-nav__item> <a href=../Patterns/ class=md-nav__link> 5. Patterns 匹配 </a> </li> <li class=md-nav__item> <a href=../Ad-hoc/ class=md-nav__link> 6. 使用 ad-hoc 命令 </a> </li> <li class=md-nav__item> <a href=../Ansible-command/ class=md-nav__link> 7. 熟悉 ansible 命令 </a> </li> <li class=md-nav__item> <a href=../Playbook/ class=md-nav__link> 8. 使用 Playbook </a> </li> <li class=md-nav__item> <a href=../Include-roles/ class=md-nav__link> 9. 包含和角色 </a> </li> <li class=md-nav__item> <a href=../Variables/ class=md-nav__link> 10. 使用变量 </a> </li> <li class=md-nav__item> <a href=../Facts/ class=md-nav__link> 11. Facts 数据 </a> </li> <li class=md-nav__item> <a href=../Jinja2/ class=md-nav__link> 12. Jinja2 模板语法 </a> </li> <li class=md-nav__item> <a href=../Conditionals-loop/ class=md-nav__link> 13. 条件判断与循环 </a> </li> <li class=md-nav__item> <a href=../Blocks/ class=md-nav__link> 14. Blocks </a> </li> <li class="md-nav__item md-nav__item--active"> <input class="md-nav__toggle md-toggle" data-md-toggle=toc type=checkbox id=__toc> <label class="md-nav__link md-nav__link--active" for=__toc> 15. Playbook 高级特性 <span class="md-nav__icon md-icon"></span> </label> <a href=./ class="md-nav__link md-nav__link--active"> 15. Playbook 高级特性 </a> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 权限提升 </a> <nav class=md-nav aria-label=权限提升> <ul class=md-nav__list> <li class=md-nav__item> <a href=#become class=md-nav__link> 使用become </a> <nav class=md-nav aria-label=使用become> <ul class=md-nav__list> <li class=md-nav__item> <a href=#become_1 class=md-nav__link> become 指令 </a> </li> <li class=md-nav__item> <a href=#become_2 class=md-nav__link> become 变量 </a> </li> <li class=md-nav__item> <a href=#become_3 class=md-nav__link> become 命令行选项 </a> </li> <li class=md-nav__item> <a href=#become_4 class=md-nav__link> become的一些限制和风险 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#become_5 class=md-nav__link> 网络模块使用become </a> <nav class=md-nav aria-label=网络模块使用become> <ul class=md-nav__list> <li class=md-nav__item> <a href=#enable class=md-nav__link> 设置所有任务的enable模式 </a> </li> <li class=md-nav__item> <a href=#enable_1 class=md-nav__link> enable模式的密码 </a> </li> <li class=md-nav__item> <a href=#authorize-auth_pass class=md-nav__link> authorize 和 auth_pass </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#windows-become class=md-nav__link> windows 使用become </a> <nav class=md-nav aria-label="windows 使用become"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#localservice class=md-nav__link> LocalService账号 </a> </li> <li class=md-nav__item> <a href=#become_6 class=md-nav__link> 无需为become设置密码 </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 没有密码的帐户 </a> </li> <li class=md-nav__item> <a href=#become_7 class=md-nav__link> become的参数 </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 限制 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> 异步操作和轮询 </a> <nav class=md-nav aria-label=异步操作和轮询> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_5 class=md-nav__link> 异步任务的状态文件 </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> 异步任务的返回值 </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> 异步任务状态的返回值 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> 检查模式 </a> </li> <li class=md-nav__item> <a href=#debug class=md-nav__link> debug 功能 </a> <nav class=md-nav aria-label="debug 功能"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#debugger class=md-nav__link> 使用 debugger 关键字 </a> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> 配置或环境变量 </a> </li> <li class=md-nav__item> <a href=#strategy class=md-nav__link> 使用 strategy 插件 </a> </li> <li class=md-nav__item> <a href=#debugger_1 class=md-nav__link> 调试 debugger </a> </li> <li class=md-nav__item> <a href=#free class=md-nav__link> 与free策略一起使用 </a> </li> <li class=md-nav__item> <a href=#debug_1 class=md-nav__link> 使用 debug 模块 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> 滚动执行 </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> 指定最大失败数目 </a> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> 委托 </a> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> 任务只运行一次 </a> </li> <li class=md-nav__item> <a href=#_14 class=md-nav__link> 本地执行 </a> </li> <li class=md-nav__item> <a href=#_15 class=md-nav__link> 设置环境变量 </a> </li> <li class=md-nav__item> <a href=#_16 class=md-nav__link> 错误处理 </a> <nav class=md-nav aria-label=错误处理> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_17 class=md-nav__link> 忽略错误 </a> </li> <li class=md-nav__item> <a href=#_18 class=md-nav__link> 重置无法访问的主机 </a> </li> <li class=md-nav__item> <a href=#handlers class=md-nav__link> 即使任务失败，handlers也执行 </a> </li> <li class=md-nav__item> <a href=#_19 class=md-nav__link> 控制任务失败 </a> </li> <li class=md-nav__item> <a href=#changed class=md-nav__link> 更改任务changed状态 </a> </li> <li class=md-nav__item> <a href=#_20 class=md-nav__link> 出现错误时立即中断执行 </a> </li> <li class=md-nav__item> <a href=#blocks class=md-nav__link> 使用blocks </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#yaml class=md-nav__link> YAML 语法 </a> </li> <li class=md-nav__item> <a href=#prompts class=md-nav__link> Prompts: 运行时，提示输入内容 </a> </li> <li class=md-nav__item> <a href=#_21 class=md-nav__link> 标记 </a> <nav class=md-nav aria-label=标记> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_22 class=md-nav__link> 标记任务 </a> </li> <li class=md-nav__item> <a href=#playbook class=md-nav__link> 标记playbook </a> </li> <li class=md-nav__item> <a href=#role class=md-nav__link> 标记role </a> </li> <li class=md-nav__item> <a href=#_23 class=md-nav__link> 标记包含 </a> </li> <li class=md-nav__item> <a href=#_24 class=md-nav__link> 特殊标记 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#vault class=md-nav__link> Vault 加密 </a> </li> <li class=md-nav__item> <a href=#_25 class=md-nav__link> 从某个任务开始执行 </a> </li> <li class=md-nav__item> <a href=#_26 class=md-nav__link> 一步一步的执行 </a> </li> <li class=md-nav__item> <a href=#_27 class=md-nav__link> 模块默认值 </a> </li> <li class=md-nav__item> <a href=#_28 class=md-nav__link> 等待 </a> </li> <li class=md-nav__item> <a href=#playbook_1 class=md-nav__link> Playbook 关键字 </a> </li> <li class=md-nav__item> <a href=#lookup class=md-nav__link> lookup 插件 </a> <nav class=md-nav aria-label="lookup 插件"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#file class=md-nav__link> 使用 file 获取文件内容 </a> </li> <li class=md-nav__item> <a href=#env class=md-nav__link> 使用 env 获取变量 </a> </li> <li class=md-nav__item> <a href=#password class=md-nav__link> 使用 password 生成密码字符串 </a> </li> <li class=md-nav__item> <a href=#csvfile-csv class=md-nav__link> 使用 csvfile 读取csv文件 </a> </li> <li class=md-nav__item> <a href=#ini-ini class=md-nav__link> 使用 ini 读取ini文件 </a> </li> <li class=md-nav__item> <a href=#dig-dns class=md-nav__link> 使用 dig dns查询 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-16 type=checkbox id=nav-4-16> <label class=md-nav__link for=nav-4-16> 扩展阅读(深入必读) <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=扩展阅读(深入必读) data-md-level=2> <label class=md-nav__title for=nav-4-16> <span class="md-nav__icon md-icon"></span> 扩展阅读(深入必读) </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Reference/Yaml/ class=md-nav__link> 1. YAML 语法 </a> </li> <li class=md-nav__item> <a href=../Reference/Vaults/ class=md-nav__link> 2. Vaults 加密数据 </a> </li> <li class=md-nav__item> <a href=../Reference/Keywords/ class=md-nav__link> 3. 关键字使用 </a> </li> <li class=md-nav__item> <a href=../Reference/Module/ class=md-nav__link> 4. 模块索引 </a> </li> <li class=md-nav__item> <a href=../Reference/Config/ class=md-nav__link> 5. Ansible 配置 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-4-17 type=checkbox id=nav-4-17> <label class=md-nav__link for=nav-4-17> Windows <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=Windows data-md-level=2> <label class=md-nav__title for=nav-4-17> <span class="md-nav__icon md-icon"></span> Windows </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../Windows/manager-windows/ class=md-nav__link> 1. 管理 Windows 主机 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-5 type=checkbox id=nav-5> <label class=md-nav__link for=nav-5> Ansible 进阶 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Ansible 进阶" data-md-level=1> <label class=md-nav__title for=nav-5> <span class="md-nav__icon md-icon"></span> Ansible 进阶 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../advanced/optimization/ class=md-nav__link> Ansible 优化 </a> </li> <li class=md-nav__item> <a href=../../advanced/ansible-config/ class=md-nav__link> Ansible 的常用设置 </a> </li> <li class=md-nav__item> <a href=../../advanced/best-practices/ class=md-nav__link> Ansible 最佳实践 </a> </li> <li class=md-nav__item> <a href=../../advanced/ansible-lint/ class=md-nav__link> 使用 Ansible-lint </a> </li> <li class=md-nav__item> <a href=../../advanced/dynamic-hosts/ class=md-nav__link> 使用动态主机 </a> </li> <li class=md-nav__item> <a href=../../advanced/dynamic-inventory/ class=md-nav__link> 使用动态主机管理云服务 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-5-7 type=checkbox id=nav-5-7> <label class=md-nav__link for=nav-5-7> Ansible 安全 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Ansible 安全" data-md-level=2> <label class=md-nav__title for=nav-5-7> <span class="md-nav__icon md-icon"></span> Ansible 安全 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../advanced/security/ class=md-nav__link> Ansible 控制节点安全 </a> </li> <li class=md-nav__item> <a href=../../advanced/security/firewall/ class=md-nav__link> - 节点安全: 防火墙设置 </a> </li> <li class=md-nav__item> <a href=../../advanced/security/ssh-2step/ class=md-nav__link> - 节点安全: ssh登录二次验证 </a> </li> <li class=md-nav__item> <a href=../../advanced/security/audit/ class=md-nav__link> - 节点安全: 命令审计 </a> </li> <li class=md-nav__item> <a href=../../advanced/security/vault-hosts/ class=md-nav__link> - 节点安全: 加密主机清单 </a> </li> <li class=md-nav__item> <a href=../../advanced/security/filter-command/ class=md-nav__link> 过滤 Ansible 危险指令 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-5-8 type=checkbox id=nav-5-8> <label class=md-nav__link for=nav-5-8> Ansible 实践 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Ansible 实践" data-md-level=2> <label class=md-nav__title for=nav-5-8> <span class="md-nav__icon md-icon"></span> Ansible 实践 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../advanced/practice/snippets/ class=md-nav__link> Ansible Task片段 </a> </li> <li class=md-nav__item> <a href=../../advanced/practice/jenkins-and-ansible/ class=md-nav__link> 在 Jenkins 中使用 Ansible </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=../../advanced/ara/ class=md-nav__link> 使用 ARA 记录 Ansible 执行结果 </a> </li> <li class=md-nav__item> <a href=../../advanced/ansible-cmdb/ class=md-nav__link> 使用 Ansible-cmdb </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-6 type=checkbox id=nav-6> <label class=md-nav__link for=nav-6> Ansible 开发 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Ansible 开发" data-md-level=1> <label class=md-nav__title for=nav-6> <span class="md-nav__icon md-icon"></span> Ansible 开发 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../dev/ class=md-nav__link> Ansible 开发说明 </a> </li> <li class=md-nav__item> <a href=../../dev/ansible-architecture/ class=md-nav__link> Ansible 架构 </a> </li> <li class=md-nav__item> <a href=../../dev/pycharm-remote-development/ class=md-nav__link> 使用 PyCharm 远程开发 </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-6-4 type=checkbox id=nav-6-4> <label class=md-nav__link for=nav-6-4> Ansible 调试 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Ansible 调试" data-md-level=2> <label class=md-nav__title for=nav-6-4> <span class="md-nav__icon md-icon"></span> Ansible 调试 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../dev/debug/verbose-debug/ class=md-nav__link> 详细输出 </a> </li> <li class=md-nav__item> <a href=../../dev/debug/pdb/ class=md-nav__link> pdb 本地调试 </a> </li> <li class=md-nav__item> <a href=../../dev/debug/pycharm/ class=md-nav__link> PyCharm 远程调试 </a> </li> <li class=md-nav__item> <a href=../../dev/debug/module-debug/ class=md-nav__link> 模块调试 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-6-5 type=checkbox id=nav-6-5> <label class=md-nav__link for=nav-6-5> Module 开发 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Module 开发" data-md-level=2> <label class=md-nav__title for=nav-6-5> <span class="md-nav__icon md-icon"></span> Module 开发 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../dev/modules/ class=md-nav__link> Module 开发说明 </a> </li> <li class=md-nav__item> <a href=../../dev/modules/remote_copy/ class=md-nav__link> 创建一个简单的module </a> </li> <li class=md-nav__item> <a href=../../dev/modules/huawei-switch/ class=md-nav__link> module 示例: 连接华为交换机 </a> </li> <li class=md-nav__item> <a href=../../dev/modules/module-outher-dev/ class=md-nav__link> module 示例: 其他语言开发 </a> </li> <li class=md-nav__item> <a href=../../dev/modules/module-shell-dir/ class=md-nav__link> module 示例: dir </a> </li> <li class=md-nav__item> <a href=../../dev/modules/module-docker-facts/ class=md-nav__link> module 示例: docker_facts </a> </li> <li class=md-nav__item> <a href=../../dev/modules/module-wechat/ class=md-nav__link> module 示例: wechat </a> </li> <li class=md-nav__item> <a href=../../dev/modules/module-return/ class=md-nav__link> module 的返回值 </a> </li> <li class=md-nav__item> <a href=../../dev/modules/module-doc/ class=md-nav__link> module 的帮助文档 </a> </li> <li class=md-nav__item> <a href=../../dev/modules/module-architecture/ class=md-nav__link> module 架构 </a> </li> <li class=md-nav__item> <a href=../../dev/modules/module-utilities/ class=md-nav__link> module 工具类 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-6-6 type=checkbox id=nav-6-6> <label class=md-nav__link for=nav-6-6> Plugin 开发 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Plugin 开发" data-md-level=2> <label class=md-nav__title for=nav-6-6> <span class="md-nav__icon md-icon"></span> Plugin 开发 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../dev/plugins/ class=md-nav__link> Plugin 开发说明 </a> </li> <li class=md-nav__item> <a href=../../dev/plugins/Action-hello/ class=md-nav__link> Action 示例: hello </a> </li> <li class=md-nav__item> <a href=../../dev/plugins/Callback-BlackHole/ class=md-nav__link> Callback 示例: BlackHole </a> </li> <li class=md-nav__item> <a href=../../dev/plugins/Filter-split/ class=md-nav__link> Filter 示例: split </a> </li> <li class=md-nav__item> <a href=../../dev/plugins/Inventory-csv/ class=md-nav__link> Inventory 示例: csv </a> </li> <li class=md-nav__item> <a href=../../dev/plugins/Lookup-github-status/ class=md-nav__link> Lookup 示例: github_status </a> </li> <li class=md-nav__item> <a href=../../dev/plugins/Vars-csv-vars/ class=md-nav__link> Vars 示例: csv_vars </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-6-7 type=checkbox id=nav-6-7> <label class=md-nav__link for=nav-6-7> API 使用 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="API 使用" data-md-level=2> <label class=md-nav__title for=nav-6-7> <span class="md-nav__icon md-icon"></span> API 使用 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../dev/api/ class=md-nav__link> API 使用说明 </a> </li> <li class=md-nav__item> <a href=../../dev/api/api-task/ class=md-nav__link> 使用 API 运行任务 </a> </li> <li class=md-nav__item> <a href=../../dev/api/api-playbook/ class=md-nav__link> 使用 API 运行 Palybook </a> </li> <li class=md-nav__item> <a href=../../dev/api/api-suitable/ class=md-nav__link> 使用 suitable </a> </li> <li class=md-nav__item> <a href=../../dev/api/api-ansible-runner/ class=md-nav__link> 使用 ansible runner </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-7 type=checkbox id=nav-7> <label class=md-nav__link for=nav-7> Ansible UI <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Ansible UI" data-md-level=1> <label class=md-nav__title for=nav-7> <span class="md-nav__icon md-icon"></span> Ansible UI </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../ui/ class=md-nav__link> Ansible UI 说明 </a> </li> <li class=md-nav__item> <a href=../../ui/awx/ class=md-nav__link> Ansible Awx </a> </li> <li class=md-nav__item> <a href=../../ui/tower/ class=md-nav__link> Ansible Tower </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-8 type=checkbox id=nav-8> <label class=md-nav__link for=nav-8> Ansible 认证 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Ansible 认证" data-md-level=1> <label class=md-nav__title for=nav-8> <span class="md-nav__icon md-icon"></span> Ansible 认证 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../certification/ class=md-nav__link> Ansible 认证说明 </a> </li> <li class=md-nav__item> <a href=../../certification/ex407-example/ class=md-nav__link> EX407 示例试题 </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9 type=checkbox id=nav-9> <label class=md-nav__link for=nav-9> Ansible Roles <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label="Ansible Roles" data-md-level=1> <label class=md-nav__title for=nav-9> <span class="md-nav__icon md-icon"></span> Ansible Roles </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../roles/ class=md-nav__link> Ansible roles 怎么用？ </a> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-2 type=checkbox id=nav-9-2> <label class=md-nav__link for=nav-9-2> 认证 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=认证 data-md-level=2> <label class=md-nav__title for=nav-9-2> <span class="md-nav__icon md-icon"></span> 认证 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../roles/auth/kerberos-client/ class=md-nav__link> kerberos-client </a> </li> <li class=md-nav__item> <a href=../../roles/auth/kerberos-server/ class=md-nav__link> kerberos-server </a> </li> <li class=md-nav__item> <a href=../../roles/auth/openldap/ class=md-nav__link> openldap </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-3 type=checkbox id=nav-9-3> <label class=md-nav__link for=nav-9-3> 系统环境 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=系统环境 data-md-level=2> <label class=md-nav__title for=nav-9-3> <span class="md-nav__icon md-icon"></span> 系统环境 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../roles/env/ant/ class=md-nav__link> ant </a> </li> <li class=md-nav__item> <a href=../../roles/env/erlang/ class=md-nav__link> erlang </a> </li> <li class=md-nav__item> <a href=../../roles/env/go/ class=md-nav__link> go </a> </li> <li class=md-nav__item> <a href=../../roles/env/hostnames/ class=md-nav__link> hostnames </a> </li> <li class=md-nav__item> <a href=../../roles/env/java/ class=md-nav__link> java </a> </li> <li class=md-nav__item> <a href=../../roles/env/lua/ class=md-nav__link> lua </a> </li> <li class=md-nav__item> <a href=../../roles/env/mvn/ class=md-nav__link> mvn </a> </li> <li class=md-nav__item> <a href=../../roles/env/nodejs/ class=md-nav__link> nodejs </a> </li> <li class=md-nav__item> <a href=../../roles/env/openssh/ class=md-nav__link> openssh </a> </li> <li class=md-nav__item> <a href=../../roles/env/openssl/ class=md-nav__link> openssl </a> </li> <li class=md-nav__item> <a href=../../roles/env/os-init/ class=md-nav__link> os-init </a> </li> <li class=md-nav__item> <a href=../../roles/env/php/ class=md-nav__link> php </a> </li> <li class=md-nav__item> <a href=../../roles/env/python2.7/ class=md-nav__link> python2.7 </a> </li> <li class=md-nav__item> <a href=../../roles/env/repo-epel/ class=md-nav__link> repo-epel </a> </li> <li class=md-nav__item> <a href=../../roles/env/ruby/ class=md-nav__link> ruby </a> </li> <li class=md-nav__item> <a href=../../roles/env/sbt/ class=md-nav__link> sbt </a> </li> <li class=md-nav__item> <a href=../../roles/env/ssh-2fa/ class=md-nav__link> ssh-2fa </a> </li> <li class=md-nav__item> <a href=../../roles/env/ssh-keys/ class=md-nav__link> ssh-keys </a> </li> <li class=md-nav__item> <a href=../../roles/env/update-kernel/ class=md-nav__link> update-kernel </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-4 type=checkbox id=nav-9-4> <label class=md-nav__link for=nav-9-4> WEB <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=WEB data-md-level=2> <label class=md-nav__title for=nav-9-4> <span class="md-nav__icon md-icon"></span> WEB </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../roles/web/nginx/ class=md-nav__link> nginx </a> </li> <li class=md-nav__item> <a href=../../roles/web/openresty/ class=md-nav__link> openresty </a> </li> <li class=md-nav__item> <a href=../../roles/web/tengine/ class=md-nav__link> tengine </a> </li> <li class=md-nav__item> <a href=../../roles/web/tomcat/ class=md-nav__link> tomcat </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-5 type=checkbox id=nav-9-5> <label class=md-nav__link for=nav-9-5> 数据库 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=数据库 data-md-level=2> <label class=md-nav__title for=nav-9-5> <span class="md-nav__icon md-icon"></span> 数据库 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../roles/database/memcached/ class=md-nav__link> memcached </a> </li> <li class=md-nav__item> <a href=../../roles/database/mongodb/ class=md-nav__link> mongodb </a> </li> <li class=md-nav__item> <a href=../../roles/database/mycat/ class=md-nav__link> mycat </a> </li> <li class=md-nav__item> <a href=../../roles/database/mysql/ class=md-nav__link> mysql </a> </li> <li class=md-nav__item> <a href=../../roles/database/mysql57/ class=md-nav__link> mysql57 </a> </li> <li class=md-nav__item> <a href=../../roles/database/redis/ class=md-nav__link> redis </a> </li> <li class=md-nav__item> <a href=../../roles/database/redis5/ class=md-nav__link> redis5 </a> </li> <li class=md-nav__item> <a href=../../roles/database/codis/ class=md-nav__link> codis </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-6 type=checkbox id=nav-9-6> <label class=md-nav__link for=nav-9-6> 键值存储 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=键值存储 data-md-level=2> <label class=md-nav__title for=nav-9-6> <span class="md-nav__icon md-icon"></span> 键值存储 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../roles/kv/consul/ class=md-nav__link> consul </a> </li> <li class=md-nav__item> <a href=../../roles/kv/etcd/ class=md-nav__link> etcd </a> </li> <li class=md-nav__item> <a href=../../roles/kv/zookeeper/ class=md-nav__link> zookeeper </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-7 type=checkbox id=nav-9-7> <label class=md-nav__link for=nav-9-7> 大数据 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=大数据 data-md-level=2> <label class=md-nav__title for=nav-9-7> <span class="md-nav__icon md-icon"></span> 大数据 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../roles/bigdata/airflow/ class=md-nav__link> airflow </a> </li> <li class=md-nav__item> <a href=../../roles/bigdata/cdh5-agent/ class=md-nav__link> cdh5-agent </a> </li> <li class=md-nav__item> <a href=../../roles/bigdata/cdh5-pre/ class=md-nav__link> cdh5-pre </a> </li> <li class=md-nav__item> <a href=../../roles/bigdata/cdh5-server/ class=md-nav__link> cdh5-server </a> </li> <li class=md-nav__item> <a href=../../roles/bigdata/hadoop-standalone/ class=md-nav__link> hadoop-standalone </a> </li> <li class=md-nav__item> <a href=../../roles/bigdata/superset/ class=md-nav__link> superset </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-8 type=checkbox id=nav-9-8> <label class=md-nav__link for=nav-9-8> 消息系统 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=消息系统 data-md-level=2> <label class=md-nav__title for=nav-9-8> <span class="md-nav__icon md-icon"></span> 消息系统 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../roles/mq/kafka/ class=md-nav__link> kafka </a> </li> <li class=md-nav__item> <a href=../../roles/mq/kafka-manager/ class=md-nav__link> kafka-manager </a> </li> <li class=md-nav__item> <a href=../../roles/mq/rabbitmq/ class=md-nav__link> rabbitmq </a> </li> <li class=md-nav__item> <a href=../../roles/mq/rocketmq/ class=md-nav__link> rocketmq </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-9 type=checkbox id=nav-9-9> <label class=md-nav__link for=nav-9-9> 持续集成/交付 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=持续集成/交付 data-md-level=2> <label class=md-nav__title for=nav-9-9> <span class="md-nav__icon md-icon"></span> 持续集成/交付 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../roles/ci/deploy-image/ class=md-nav__link> deploy-image </a> </li> <li class=md-nav__item> <a href=../../roles/ci/deploy-static/ class=md-nav__link> deploy-static </a> </li> <li class=md-nav__item> <a href=../../roles/ci/deploy-supervisor/ class=md-nav__link> deploy-supervisor </a> </li> <li class=md-nav__item> <a href=../../roles/ci/deploy-tomcat/ class=md-nav__link> deploy-tomcat </a> </li> <li class=md-nav__item> <a href=../../roles/ci/jenkins/ class=md-nav__link> jenkins </a> </li> <li class=md-nav__item> <a href=../../roles/ci/nexus/ class=md-nav__link> nexus </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-10 type=checkbox id=nav-9-10> <label class=md-nav__link for=nav-9-10> 高可用 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=高可用 data-md-level=2> <label class=md-nav__title for=nav-9-10> <span class="md-nav__icon md-icon"></span> 高可用 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../roles/ha/keepalived/ class=md-nav__link> keepalived </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-11 type=checkbox id=nav-9-11> <label class=md-nav__link for=nav-9-11> 代理 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=代理 data-md-level=2> <label class=md-nav__title for=nav-9-11> <span class="md-nav__icon md-icon"></span> 代理 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../roles/proxy/haproxy/ class=md-nav__link> haproxy </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-12 type=checkbox id=nav-9-12> <label class=md-nav__link for=nav-9-12> 监控 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=监控 data-md-level=2> <label class=md-nav__title for=nav-9-12> <span class="md-nav__icon md-icon"></span> 监控 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../roles/monitor/grafana/ class=md-nav__link> grafana </a> </li> <li class=md-nav__item> <a href=../../roles/monitor/zabbix-agent/ class=md-nav__link> zabbix-agent </a> </li> <li class=md-nav__item> <a href=../../roles/monitor/zabbix-server/ class=md-nav__link> zabbix-server </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-13 type=checkbox id=nav-9-13> <label class=md-nav__link for=nav-9-13> 日志分析 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=日志分析 data-md-level=2> <label class=md-nav__title for=nav-9-13> <span class="md-nav__icon md-icon"></span> 日志分析 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../roles/log/elasticsearch/ class=md-nav__link> elasticsearch </a> </li> <li class=md-nav__item> <a href=../../roles/log/filebeat/ class=md-nav__link> filebeat </a> </li> <li class=md-nav__item> <a href=../../roles/log/grokdebug/ class=md-nav__link> grokdebug </a> </li> <li class=md-nav__item> <a href=../../roles/log/kibana/ class=md-nav__link> kibana </a> </li> <li class=md-nav__item> <a href=../../roles/log/logstash/ class=md-nav__link> logstash </a> </li> <li class=md-nav__item> <a href=../../roles/log/heartbeat/ class=md-nav__link> heartbeat </a> </li> <li class=md-nav__item> <a href=../../roles/log/metricbeat/ class=md-nav__link> metricbeat </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-14 type=checkbox id=nav-9-14> <label class=md-nav__link for=nav-9-14> 存储 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=存储 data-md-level=2> <label class=md-nav__title for=nav-9-14> <span class="md-nav__icon md-icon"></span> 存储 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../roles/storage/gluster/ class=md-nav__link> gluster </a> </li> <li class=md-nav__item> <a href=../../roles/storage/nfs/ class=md-nav__link> nfs </a> </li> <li class=md-nav__item> <a href=../../roles/storage/samba/ class=md-nav__link> samba </a> </li> <li class=md-nav__item> <a href=../../roles/storage/vsftpd/ class=md-nav__link> vsftpd </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-15 type=checkbox id=nav-9-15> <label class=md-nav__link for=nav-9-15> 容器 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=容器 data-md-level=2> <label class=md-nav__title for=nav-9-15> <span class="md-nav__icon md-icon"></span> 容器 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../roles/container/docker-compose/ class=md-nav__link> docker-compose </a> </li> <li class=md-nav__item> <a href=../../roles/container/docker-swarm/ class=md-nav__link> docker-swarm </a> </li> <li class=md-nav__item> <a href=../../roles/container/docker/ class=md-nav__link> docker </a> </li> <li class=md-nav__item> <a href=../../roles/container/harbor/ class=md-nav__link> harbor </a> </li> <li class=md-nav__item> <a href=../../roles/container/kubernetes-bin/ class=md-nav__link> kubernetes-bin </a> </li> <li class=md-nav__item> <a href=../../roles/container/kubernetes/ class=md-nav__link> kubernetes </a> </li> <li class=md-nav__item> <a href=../../roles/container/shipyard/ class=md-nav__link> shipyard </a> </li> <li class=md-nav__item> <a href=../../roles/container/nomad/ class=md-nav__link> nomad </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-16 type=checkbox id=nav-9-16> <label class=md-nav__link for=nav-9-16> 数据同步 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=数据同步 data-md-level=2> <label class=md-nav__title for=nav-9-16> <span class="md-nav__icon md-icon"></span> 数据同步 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../roles/sync/rsync/ class=md-nav__link> rsync </a> </li> <li class=md-nav__item> <a href=../../roles/sync/sersync/ class=md-nav__link> sersync </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-17 type=checkbox id=nav-9-17> <label class=md-nav__link for=nav-9-17> 运维管理 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=运维管理 data-md-level=2> <label class=md-nav__title for=nav-9-17> <span class="md-nav__icon md-icon"></span> 运维管理 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../roles/ops/os-check/ class=md-nav__link> os-check </a> </li> <li class=md-nav__item> <a href=../../roles/ops/backup-file/ class=md-nav__link> backup-file </a> </li> </ul> </nav> </li> <li class="md-nav__item md-nav__item--nested"> <input class="md-nav__toggle md-toggle" data-md-toggle=nav-9-18 type=checkbox id=nav-9-18> <label class=md-nav__link for=nav-9-18> 其他 <span class="md-nav__icon md-icon"></span> </label> <nav class=md-nav aria-label=其他 data-md-level=2> <label class=md-nav__title for=nav-9-18> <span class="md-nav__icon md-icon"></span> 其他 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=../../roles/other/chrony/ class=md-nav__link> chrony </a> </li> <li class=md-nav__item> <a href=../../roles/other/confd/ class=md-nav__link> confd </a> </li> <li class=md-nav__item> <a href=../../roles/other/iptables/ class=md-nav__link> iptables </a> </li> <li class=md-nav__item> <a href=../../roles/other/ntp/ class=md-nav__link> ntp </a> </li> <li class=md-nav__item> <a href=../../roles/other/supervisor/ class=md-nav__link> supervisor </a> </li> <li class=md-nav__item> <a href=../../roles/other/vault/ class=md-nav__link> vault </a> </li> <li class=md-nav__item> <a href=../../roles/other/cfssl/ class=md-nav__link> cfssl </a> </li> </ul> </nav> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class="md-sidebar md-sidebar--secondary" data-md-component=toc> <div class=md-sidebar__scrollwrap> <div class=md-sidebar__inner> <nav class="md-nav md-nav--secondary" aria-label=目录> <label class=md-nav__title for=__toc> <span class="md-nav__icon md-icon"></span> 目录 </label> <ul class=md-nav__list data-md-scrollfix> <li class=md-nav__item> <a href=#_1 class=md-nav__link> 权限提升 </a> <nav class=md-nav aria-label=权限提升> <ul class=md-nav__list> <li class=md-nav__item> <a href=#become class=md-nav__link> 使用become </a> <nav class=md-nav aria-label=使用become> <ul class=md-nav__list> <li class=md-nav__item> <a href=#become_1 class=md-nav__link> become 指令 </a> </li> <li class=md-nav__item> <a href=#become_2 class=md-nav__link> become 变量 </a> </li> <li class=md-nav__item> <a href=#become_3 class=md-nav__link> become 命令行选项 </a> </li> <li class=md-nav__item> <a href=#become_4 class=md-nav__link> become的一些限制和风险 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#become_5 class=md-nav__link> 网络模块使用become </a> <nav class=md-nav aria-label=网络模块使用become> <ul class=md-nav__list> <li class=md-nav__item> <a href=#enable class=md-nav__link> 设置所有任务的enable模式 </a> </li> <li class=md-nav__item> <a href=#enable_1 class=md-nav__link> enable模式的密码 </a> </li> <li class=md-nav__item> <a href=#authorize-auth_pass class=md-nav__link> authorize 和 auth_pass </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#windows-become class=md-nav__link> windows 使用become </a> <nav class=md-nav aria-label="windows 使用become"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#localservice class=md-nav__link> LocalService账号 </a> </li> <li class=md-nav__item> <a href=#become_6 class=md-nav__link> 无需为become设置密码 </a> </li> <li class=md-nav__item> <a href=#_2 class=md-nav__link> 没有密码的帐户 </a> </li> <li class=md-nav__item> <a href=#become_7 class=md-nav__link> become的参数 </a> </li> <li class=md-nav__item> <a href=#_3 class=md-nav__link> 限制 </a> </li> </ul> </nav> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_4 class=md-nav__link> 异步操作和轮询 </a> <nav class=md-nav aria-label=异步操作和轮询> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_5 class=md-nav__link> 异步任务的状态文件 </a> </li> <li class=md-nav__item> <a href=#_6 class=md-nav__link> 异步任务的返回值 </a> </li> <li class=md-nav__item> <a href=#_7 class=md-nav__link> 异步任务状态的返回值 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_8 class=md-nav__link> 检查模式 </a> </li> <li class=md-nav__item> <a href=#debug class=md-nav__link> debug 功能 </a> <nav class=md-nav aria-label="debug 功能"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#debugger class=md-nav__link> 使用 debugger 关键字 </a> </li> <li class=md-nav__item> <a href=#_9 class=md-nav__link> 配置或环境变量 </a> </li> <li class=md-nav__item> <a href=#strategy class=md-nav__link> 使用 strategy 插件 </a> </li> <li class=md-nav__item> <a href=#debugger_1 class=md-nav__link> 调试 debugger </a> </li> <li class=md-nav__item> <a href=#free class=md-nav__link> 与free策略一起使用 </a> </li> <li class=md-nav__item> <a href=#debug_1 class=md-nav__link> 使用 debug 模块 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#_10 class=md-nav__link> 滚动执行 </a> </li> <li class=md-nav__item> <a href=#_11 class=md-nav__link> 指定最大失败数目 </a> </li> <li class=md-nav__item> <a href=#_12 class=md-nav__link> 委托 </a> </li> <li class=md-nav__item> <a href=#_13 class=md-nav__link> 任务只运行一次 </a> </li> <li class=md-nav__item> <a href=#_14 class=md-nav__link> 本地执行 </a> </li> <li class=md-nav__item> <a href=#_15 class=md-nav__link> 设置环境变量 </a> </li> <li class=md-nav__item> <a href=#_16 class=md-nav__link> 错误处理 </a> <nav class=md-nav aria-label=错误处理> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_17 class=md-nav__link> 忽略错误 </a> </li> <li class=md-nav__item> <a href=#_18 class=md-nav__link> 重置无法访问的主机 </a> </li> <li class=md-nav__item> <a href=#handlers class=md-nav__link> 即使任务失败，handlers也执行 </a> </li> <li class=md-nav__item> <a href=#_19 class=md-nav__link> 控制任务失败 </a> </li> <li class=md-nav__item> <a href=#changed class=md-nav__link> 更改任务changed状态 </a> </li> <li class=md-nav__item> <a href=#_20 class=md-nav__link> 出现错误时立即中断执行 </a> </li> <li class=md-nav__item> <a href=#blocks class=md-nav__link> 使用blocks </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#yaml class=md-nav__link> YAML 语法 </a> </li> <li class=md-nav__item> <a href=#prompts class=md-nav__link> Prompts: 运行时，提示输入内容 </a> </li> <li class=md-nav__item> <a href=#_21 class=md-nav__link> 标记 </a> <nav class=md-nav aria-label=标记> <ul class=md-nav__list> <li class=md-nav__item> <a href=#_22 class=md-nav__link> 标记任务 </a> </li> <li class=md-nav__item> <a href=#playbook class=md-nav__link> 标记playbook </a> </li> <li class=md-nav__item> <a href=#role class=md-nav__link> 标记role </a> </li> <li class=md-nav__item> <a href=#_23 class=md-nav__link> 标记包含 </a> </li> <li class=md-nav__item> <a href=#_24 class=md-nav__link> 特殊标记 </a> </li> </ul> </nav> </li> <li class=md-nav__item> <a href=#vault class=md-nav__link> Vault 加密 </a> </li> <li class=md-nav__item> <a href=#_25 class=md-nav__link> 从某个任务开始执行 </a> </li> <li class=md-nav__item> <a href=#_26 class=md-nav__link> 一步一步的执行 </a> </li> <li class=md-nav__item> <a href=#_27 class=md-nav__link> 模块默认值 </a> </li> <li class=md-nav__item> <a href=#_28 class=md-nav__link> 等待 </a> </li> <li class=md-nav__item> <a href=#playbook_1 class=md-nav__link> Playbook 关键字 </a> </li> <li class=md-nav__item> <a href=#lookup class=md-nav__link> lookup 插件 </a> <nav class=md-nav aria-label="lookup 插件"> <ul class=md-nav__list> <li class=md-nav__item> <a href=#file class=md-nav__link> 使用 file 获取文件内容 </a> </li> <li class=md-nav__item> <a href=#env class=md-nav__link> 使用 env 获取变量 </a> </li> <li class=md-nav__item> <a href=#password class=md-nav__link> 使用 password 生成密码字符串 </a> </li> <li class=md-nav__item> <a href=#csvfile-csv class=md-nav__link> 使用 csvfile 读取csv文件 </a> </li> <li class=md-nav__item> <a href=#ini-ini class=md-nav__link> 使用 ini 读取ini文件 </a> </li> <li class=md-nav__item> <a href=#dig-dns class=md-nav__link> 使用 dig dns查询 </a> </li> </ul> </nav> </li> </ul> </nav> </div> </div> </div> <div class=md-content> <article class="md-content__inner md-typeset"> <a href=https://github.com/leops-china/ansible-wiki/edit/master/docs/basic/Playbook-features.md title=编辑此页 class="md-content__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20.71 7.04c.39-.39.39-1.04 0-1.41l-2.34-2.34c-.37-.39-1.02-.39-1.41 0l-1.84 1.83 3.75 3.75M3 17.25V21h3.75L17.81 9.93l-3.75-3.75L3 17.25z"/></svg> </a> <h1 id=15-playbook>15. Playbook 高级特性<a class=headerlink href=#15-playbook title="Permanent link">&para;</a></h1> <h2 id=_1>权限提升<a class=headerlink href=#_1 title="Permanent link">&para;</a></h2> <p>Ansible使用现有的权限升级系统来执行具有<code>root</code>权限或其他用户权限的任务。因为这个特性允许您成为另一个用户，与登录到机器的用户(远程用户)不同，所以我们将其称为<code>become</code>。<code>become</code>关键字利用现有的权限升级工具，如<code>sudo</code>、<code>su</code>、<code>pfexec</code>、<code>doas</code>、<code>pbrun</code>、<code>dzdo</code>、<code>ksu</code>、<code>runas</code>、<code>machinectl</code>等。 </p> <h3 id=become>使用become<a class=headerlink href=#become title="Permanent link">&para;</a></h3> <p>你可以在 <code>play</code>或 <code>task</code> 上使用<code>become</code>，同时使用时，优先级规则会决定哪个生效。</p> <h4 id=become_1>become 指令<a class=headerlink href=#become_1 title="Permanent link">&para;</a></h4> <ul> <li>become 设置<code>yes</code>即开启提升权限</li> <li>become_user 指定提升权限的用户</li> <li>become_method 指定提升权限的方式，有sudo，su，runas等。</li> <li>become_flags 传给可执行文件的参数</li> </ul> <p>例如，启动服务需要<code>root</code>权限</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Ensure the httpd service is running</span>
  <span class=nt>service</span><span class=p>:</span>
    <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">httpd</span>
    <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">started</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
</code></pre></div> <p>以apache用户身份运行命令</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Run a command as the apache user</span>
  <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">somecommand</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class=nt>become_user</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">apache</span>
</code></pre></div> <p>当shell为nologin时，作为nobody用户执行某些操作</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Run a command as nobody</span>
  <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">somecommand</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class=nt>become_method</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">su</span>
  <span class=nt>become_user</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">nobody</span>
  <span class=nt>become_flags</span><span class=p>:</span> <span class=s>&#39;-s</span><span class=nv> </span><span class=s>/bin/sh&#39;</span>
</code></pre></div> <h4 id=become_2>become 变量<a class=headerlink href=#become_2 title="Permanent link">&para;</a></h4> <p>在主机清单中可以为节点定义不同的<code>become</code>选项，使用下列变量</p> <ul> <li>ansible_become 开启提升权限</li> <li>ansible_become_method 提升权限的方式，有sudo，su，runas等。</li> <li>ansible_become_user 提升权限的用户</li> <li>ansible_become_pass 提升权限的用户密码</li> </ul> <p>例如，如果您希望在一个名为webserver的服务器上以root身份运行所有任务，但是您只能作为manager用户连接，那么您可以使用类似这样的库存条目 </p> <div class=highlight><pre><span></span><code><span class=na>webserver ansible_user</span><span class=o>=</span><span class=s>manager ansible_become=yes</span>
</code></pre></div> <h4 id=become_3>become 命令行选项<a class=headerlink href=#become_3 title="Permanent link">&para;</a></h4> <ul> <li>--become，-b</li> <li>--ask-become-pass, -K 告诉程序提升权限的用户密码</li> <li>--become-method 提升权限的方式，有sudo，su，runas等。</li> <li>--become-user 提升权限的用户</li> </ul> <div class=highlight><pre><span></span><code>ansible -i hosts node1 -m shell -a <span class=s2>&quot;whoami&quot;</span> --become  --become-method<span class=o>=</span>su --become-user<span class=o>=</span>root --ask-become-pass

ansible-playbook -i hosts test.yml --become  --become-method<span class=o>=</span>su --become-user<span class=o>=</span>root --ask-become-pass
</code></pre></div> <h4 id=become_4>become的一些限制和风险<a class=headerlink href=#become_4 title="Permanent link">&para;</a></h4> <ul> <li>成为无特权用户的风险</li> <li>不是所有的连接插件都支持特权升级</li> <li>每个主机只能启用一个特权升级模式(su,sudo...)</li> <li>特权升级不能限制某些命令能升级，这样会导致ansible执行时出现错误。</li> <li>不能访问由<code>pam_systemd</code>填充的环境变量</li> </ul> <h3 id=become_5>网络模块使用become<a class=headerlink href=#become_5 title="Permanent link">&para;</a></h3> <p>从2.6版开始，Ansible在所有支持enable模式的网络设备上进行特权升级(进入enable模式或特权EXEC模式) </p> <p>你必须将连接类型设置为<code>connection: network_cli</code>或<code>connection: httpapi</code>，才能在网络设备上使用<code>become</code>进行权限升级。 </p> <p>若要设置特定任务的<code>enable</code>模式，请在任务级别上添加<code>become</code></p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Gather facts (eos)</span>
  <span class=nt>eos_facts</span><span class=p>:</span>
    <span class=nt>gather_subset</span><span class=p>:</span>
      <span class="p p-Indicator">-</span> <span class=s>&quot;!hardware&quot;</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class=nt>become_method</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">enable</span>
</code></pre></div> <p>若要为单个play中的所有任务设置<code>enable</code>模式，请在play级别上添加<code>become</code></p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">eos-switches</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class=nt>become_method</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">enable</span>
  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Gather facts (eos)</span>
      <span class=nt>eos_facts</span><span class=p>:</span>
        <span class=nt>gather_subset</span><span class=p>:</span>
          <span class="p p-Indicator">-</span> <span class=s>&quot;!hardware&quot;</span>
</code></pre></div> <h4 id=enable>设置所有任务的<code>enable</code>模式<a class=headerlink href=#enable title="Permanent link">&para;</a></h4> <p>通常，您希望所有play中的所有任务都使用特权模式运行，这最好通过使用组变量来实现</p> <div class=highlight><pre><span></span><code><span class=nt>ansible_connection</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">network_cli</span>
<span class=nt>ansible_network_os</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">eos</span>
<span class=nt>ansible_user</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">myuser</span>
<span class=nt>ansible_become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
<span class=nt>ansible_become_method</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">enable</span>
</code></pre></div> <h4 id=enable_1>enable模式的密码<a class=headerlink href=#enable_1 title="Permanent link">&para;</a></h4> <p>如果需要密码才能进入<code>enable</code>模式，可以通过以下两种方式之一进行指定</p> <ul> <li>提供 <code>--ask-become-pass</code>命令行选项 </li> <li>设置<code>ansible_become_password</code> 连接变量 </li> </ul> <h4 id=authorize-auth_pass>authorize 和 auth_pass<a class=headerlink href=#authorize-auth_pass title="Permanent link">&para;</a></h4> <p>ansible 依然支持 <code>connection: local</code> 连接下的<code>enable</code>模式</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">eos-switches</span>
  <span class=nt>ansible_connection</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">local</span>
  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Gather facts (eos)</span>
      <span class=nt>eos_facts</span><span class=p>:</span>
        <span class=nt>gather_subset</span><span class=p>:</span>
          <span class="p p-Indicator">-</span> <span class=s>&quot;!hardware&quot;</span>
      <span class=nt>provider</span><span class=p>:</span>
        <span class=nt>authorize</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
        <span class=nt>auth_pass</span><span class=p>:</span> <span class=s>&quot;</span><span class=nv> </span><span class=s>{{</span><span class=nv> </span><span class=s>secret_auth_pass</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <h3 id=windows-become>windows 使用become<a class=headerlink href=#windows-become title="Permanent link">&para;</a></h3> <p>从Ansible 2.3开始，可以通过<code>runas</code>方法在Windows主机上使用<code>become</code>。在Windows上的Become使用与在非Windows主机上相同的库存设置和调用参数，因此设置和变量名与本文档中定义的相同。 </p> <p>Windows中的许多任务需要管理权限才能完成。当使用runas become方法时，Ansible将尝试使用远程用户可用的全部特权运行模块。如果未能提升用户令牌，则在执行期间将继续使用有限的令牌。 </p> <p>用户必须具有<code>SeDebugPrivilege</code>才能运行具有提升特权的成为进程。这个特权默认分配给管理员。如果调试特权不可用，则become进程将使用一组有限的特权和组运行。 </p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>win_whoami</span><span class=p>:</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
</code></pre></div> <p>在返回的<code>label.account_name</code>中体现了是否获取特权</p> <ul> <li> <p><code>Medium</code>: Ansible未能得到提升的令牌，并运行在一个有限的令牌。 </p> </li> <li> <p><code>High</code>: 获得了提升的令牌，并在任务中使用</p> </li> <li> <p><code>System</code>: <code>NT AUTHORITY\System</code>帐户被使用，并且具有最高级别的可用特权。</p> </li> </ul> <p>如果在大于2.5的Ansible版本上运行或正常的runas升级过程失败，可以通过 </p> <ul> <li> <p>将<code>become_user</code>设置为<code>System</code> 以便拥有最高权限</p> </li> <li> <p>为WinRM连接用户授予<code>SeTcbPrivilege</code>权限， <code>SeTcbPrivilege</code>是一种高级特权，它授予对操作系统的完全控制。您可以使用下面的任务在Windows主机上设置此特权</p> </li> </ul> <div class=highlight><pre><span></span><code> <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">grant the ansible user the SeTcbPrivilege right</span>
   <span class=nt>win_user_right</span><span class=p>:</span>
     <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">SeTcbPrivilege</span>
     <span class=nt>users</span><span class=p>:</span> <span class=s>&#39;{{ansible_user}}&#39;</span>
     <span class=nt>action</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">add</span>
</code></pre></div> <ul> <li>关闭主机上的UAC并重启主机, UAC是一种安全协议，它被设计为使用最少特权原则运行帐户。您可以通过运行以下任务来关闭UAC </li> </ul> <div class=highlight><pre><span></span><code> <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">turn UAC off</span>
   <span class=nt>win_regedit</span><span class=p>:</span>
     <span class=nt>path</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">HKLM:\SOFTWARE\Microsoft\Windows\CurrentVersion\policies\system</span>
     <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">EnableLUA</span>
     <span class=nt>data</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
     <span class=nt>type</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">dword</span>
     <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
   <span class=nt>register</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">uac_result</span>

 <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">reboot after disabling UAC</span>
   <span class=nt>win_reboot</span><span class=p>:</span>
   <span class=nt>when</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">uac_result is changed</span>
</code></pre></div> <blockquote> <p>授予<code>SeTcbPrivilege</code>或关闭UAC可能会导致Windows安全漏洞，如果采取了这些步骤，应该谨慎对待。 </p> </blockquote> <h4 id=localservice>LocalService账号<a class=headerlink href=#localservice title="Permanent link">&para;</a></h4> <p>在Ansible 2.5版本之前，become只能在本地或域用户帐户的Windows上工作。在这些旧版本中，像<code>System</code>或<code>NetworkService</code>这样的本地服务帐户不能用作用户。自Ansible 2.5发布以来，这一限制已经解除。可以在成为用户下面设置的三个服务帐户是 </p> <ul> <li>System</li> <li>NetworkService</li> <li>LocalService</li> </ul> <p>由于本地服务帐户没有密码，所以<code>ansible_become_password</code>参数不是必需的，如果指定了该参数也会被被忽略。</p> <h4 id=become_6>无需为become设置密码<a class=headerlink href=#become_6 title="Permanent link">&para;</a></h4> <p>从Ansible 2.8开始，become可以被用来成为一个Windows本地或域帐户，而不需要该帐户的密码。要使此方法工作，必须满足以下要求</p> <ul> <li> <p>该连接用户拥有<code>SeDebugPrivilege</code>权限</p> </li> <li> <p>该连接用户属于<code>BUILTIN\Administrators</code>组</p> </li> <li> <p>该连接用户拥有<code>SeBatchLogonRight</code>或<code>SeNetworkLogonRight</code>用户权限</p> </li> </ul> <p>通过两种不同的方法之一可以使用使用无密码方式：</p> <ul> <li> <p>复制现有的登录会话令牌(如果帐户已经登录)</p> </li> <li> <p>使用S4U生成仅在远程主机上有效的登录令牌</p> </li> </ul> <h4 id=_2>没有密码的帐户<a class=headerlink href=#_2 title="Permanent link">&para;</a></h4> <p>Ansible可以使用一个没有密码的Windows帐户(像Guest帐户)。要成为一个没有密码的帐户，必须设置<code>ansible_become_password: ''</code>。</p> <p>要想实现无密码登录，还需要将本地策略帐户:将本地帐户使用空白密码限制为仅用于控制台登录禁用。这可以通过组策略对象(GPO)完成，也可以通过这个可能的任务完成 </p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">allow blank password on become</span>
  <span class=nt>win_regedit</span><span class=p>:</span>
    <span class=nt>path</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">HKLM:\SYSTEM\CurrentControlSet\Control\Lsa</span>
    <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">LimitBlankPasswordUse</span>
    <span class=nt>data</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
    <span class=nt>type</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">dword</span>
    <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
</code></pre></div> <h4 id=become_7>become的参数<a class=headerlink href=#become_7 title="Permanent link">&para;</a></h4> <p>windows支持的<code>ansible_become_flags</code>有两个<code>logon_type</code> , <code>logon_flags</code></p> <p><code>logon_type</code> 是指定登录操作类型，有以下可选项:</p> <ul> <li> <p>interactive: 默认登录类型。该流程将在与本地运行流程相同的上下文中运行。这绕过了所有的WinRM限制，是推荐使用的方法。 </p> </li> <li> <p>batch: 在类似于设置了密码的调度任务的批处理上下文中运行该进程。</p> </li> <li> <p>new_credentials: 在与调用用户相同的凭据下运行</p> </li> <li> <p>network: 在没有任何缓存凭据的网络上下文中运行进程。</p> </li> <li> <p>network_cleartext: 与网络登录类型类似，但缓存凭据以便它可以访问网络资源。</p> </li> </ul> <p><code>logon_flags</code>指定在创建新进程时，Windows将如何记录用户的登录。 有以下可选项:</p> <ul> <li>with_profile： 默认值。 该过程会将HKEY_USERS注册表项中的用户个人资料加载到HKEY_CURRENT_USER。 </li> <li>netcredentials_only： 该过程将使用与调用方相同的令牌，但是在访问远程资源时将使用begin_user和begin_password。 </li> </ul> <p>一些例子</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">copy a file from a fileshare with custom credentials</span>
  <span class=nt>win_copy</span><span class=p>:</span>
    <span class=nt>src</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">\\server\share\data\file.txt</span>
    <span class=nt>dest</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">C:\temp\file.txt</span>
    <span class=nt>remote_src</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class=nt>vars</span><span class=p>:</span>
    <span class=nt>ansible_become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
    <span class=nt>ansible_become_method</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">runas</span>
    <span class=nt>ansible_become_user</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">DOMAIN\user</span>
    <span class=nt>ansible_become_password</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Password01</span>
    <span class=nt>ansible_become_flags</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">logon_type=new_credentials logon_flags=netcredentials_only</span>

<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">run a command under a batch logon</span>
  <span class=nt>win_whoami</span><span class=p>:</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class=nt>become_flags</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">logon_type=batch</span>

<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">run a command and not load the user profile</span>
  <span class=nt>win_whomai</span><span class=p>:</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class=nt>become_flags</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">logon_flags=</span>
</code></pre></div> <h4 id=_3>限制<a class=headerlink href=#_3 title="Permanent link">&para;</a></h4> <ul> <li> <p>仅当使用Ansible 2.7或更高版本时，<code>async</code>和<code>become</code>任务才能在Windows Server 2008、2008 R2和Windows 7上运行。</p> </li> <li> <p>默认情况下，<code>become</code>用户使用交互式会话登录，因此它必须有权在Windows主机上进行登录。 如果它不继承SeAllowLogOnLocally特权或继承SeDenyLogOnLocally特权，则提权过程将失败。 添加特权或设置logon_type标志以更改使用的登录类型。 </p> </li> <li> <p>在Ansible version 2.3之前，只有当 <code>ansible_winrm_transport</code>是basic或credssp时，become才能工作。这个限制已经被解除，自从2.4版的Ansible为所有主机除了Windows Server 2008(非R2版本)。</p> </li> <li> <p>二级登录服务<code>seclogon</code>必须运行才能使用<code>ansible_become_method: runas</code></p> </li> </ul> <h2 id=_4>异步操作和轮询<a class=headerlink href=#_4 title="Permanent link">&para;</a></h2> <p>默认情况下playbook中的任务执行时会一直保持连接,直到该任务在每个节点都执行完毕.有时这是不必要的,比如有些操作运行时间比SSH超时时间还要长.解决该问题最简单的方式是异步执行它们,然后轮询直到任务执行完毕.</p> <p>你也可以对执行时间非常长（有可能遭遇超时）的操作使用异步模式.</p> <p>为了异步启动一个任务,可以指定其最大超时时间以及轮询其状态的频率.如果你没有为 poll 指定值,那么默认的轮询频率是15秒钟。</p> <p>例如下面的palybook</p> <div class=highlight><pre><span></span><code><span class=nn>---</span>
<span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.77.131</span>

  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>shell</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">sleep 100 &amp;&amp; hostname</span>
      <span class=nt>async</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">100</span>
      <span class=nt>poll</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
      <span class=nt>register</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">result</span>

    <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">var=result</span>

    <span class="p p-Indicator">-</span> <span class=nt>async_status</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">jid={{  result.ansible_job_id }}</span>
      <span class=nt>register</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">job_result</span>
      <span class=nt>until</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">job_result.finished</span>
      <span class=nt>retries</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">30</span>
</code></pre></div> <blockquote> <p>poll指定任务的轮训值，poll=0时，任务执行后，会立即执行下一条任务。poll&gt;0时，会阻塞任务，直到任务执行完毕或超时。没有设置的时候，取默认值<code>DEFAULT_POLL_INTERVAL</code></p> </blockquote> <ul> <li>第一个任务，指定shell任务为异步执行，100秒后任务失败。</li> <li>第二个任务，获取异步任务的返回值，其目的是获取jid。</li> <li>第三个任务，检查jid异步任务的状态，当异步任务的finished不为0时，异步任务执行成功。检查次数为30次，间隔5秒。</li> </ul> <p>运行playbook的结果信息 <div class=highlight><pre><span></span><code><span class=c1># ansible-playbook  asynctest.yml -vv</span>
ansible-playbook <span class=m>2</span>.9.6
  config <span class=nv>file</span> <span class=o>=</span> /etc/ansible/ansible.cfg
  configured module search <span class=nv>path</span> <span class=o>=</span> <span class=o>[</span>u<span class=s1>&#39;/root/.ansible/plugins/modules&#39;</span>, u<span class=s1>&#39;/usr/share/ansible/plugins/modules&#39;</span><span class=o>]</span>
  ansible python module <span class=nv>location</span> <span class=o>=</span> /usr/lib/python2.7/site-packages/ansible
  executable <span class=nv>location</span> <span class=o>=</span> /usr/bin/ansible-playbook
  python <span class=nv>version</span> <span class=o>=</span> <span class=m>2</span>.7.5 <span class=o>(</span>default, Aug  <span class=m>4</span> <span class=m>2017</span>, <span class=m>00</span>:39:18<span class=o>)</span> <span class=o>[</span>GCC <span class=m>4</span>.8.5 <span class=m>20150623</span> <span class=o>(</span>Red Hat <span class=m>4</span>.8.5-16<span class=o>)]</span>
Using /etc/ansible/ansible.cfg as config file

PLAYBOOK: asynctest.yaml ******************************************************************************************************************
<span class=m>1</span> plays in asynctest.yaml

PLAY <span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span> *********************************************************************************************************************

TASK <span class=o>[</span>Gathering Facts<span class=o>]</span> ********************************************************************************************************************
task path: /etc/ansible/asynctest.yaml:2
ok: <span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span>
META: ran handlers

TASK <span class=o>[</span>shell<span class=o>]</span> ******************************************************************************************************************************
task path: /etc/ansible/asynctest.yaml:5
changed: <span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span> <span class=o>=</span>&gt; <span class=o>{</span><span class=s2>&quot;ansible_job_id&quot;</span>: <span class=s2>&quot;965275577324.14846&quot;</span>, <span class=s2>&quot;changed&quot;</span>: true, <span class=s2>&quot;finished&quot;</span>: <span class=m>0</span>, <span class=s2>&quot;results_file&quot;</span>: <span class=s2>&quot;/root/.ansible_async/965275577324.14846&quot;</span>, <span class=s2>&quot;started&quot;</span>: <span class=m>1</span><span class=o>}</span>

TASK <span class=o>[</span>debug<span class=o>]</span> ******************************************************************************************************************************
task path: /etc/ansible/asynctest.yaml:9
ok: <span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span> <span class=o>=</span>&gt; <span class=o>{</span>
    <span class=s2>&quot;result&quot;</span>: <span class=o>{</span>
        <span class=s2>&quot;ansible_job_id&quot;</span>: <span class=s2>&quot;965275577324.14846&quot;</span>, 
        <span class=s2>&quot;changed&quot;</span>: true, 
        <span class=s2>&quot;failed&quot;</span>: false, 
        <span class=s2>&quot;finished&quot;</span>: <span class=m>0</span>, 
        <span class=s2>&quot;results_file&quot;</span>: <span class=s2>&quot;/root/.ansible_async/965275577324.14846&quot;</span>, 
        <span class=s2>&quot;started&quot;</span>: <span class=m>1</span>
    <span class=o>}</span>
<span class=o>}</span>

TASK <span class=o>[</span>async_status<span class=o>]</span> ***********************************************************************************************************************
task path: /etc/ansible/asynctest.yaml:11
FAILED - RETRYING: async_status <span class=o>(</span><span class=m>30</span> retries left<span class=o>)</span>.
FAILED - RETRYING: async_status <span class=o>(</span><span class=m>29</span> retries left<span class=o>)</span>.
FAILED - RETRYING: async_status <span class=o>(</span><span class=m>28</span> retries left<span class=o>)</span>.
FAILED - RETRYING: async_status <span class=o>(</span><span class=m>27</span> retries left<span class=o>)</span>.
FAILED - RETRYING: async_status <span class=o>(</span><span class=m>26</span> retries left<span class=o>)</span>.
FAILED - RETRYING: async_status <span class=o>(</span><span class=m>25</span> retries left<span class=o>)</span>.
FAILED - RETRYING: async_status <span class=o>(</span><span class=m>24</span> retries left<span class=o>)</span>.
FAILED - RETRYING: async_status <span class=o>(</span><span class=m>23</span> retries left<span class=o>)</span>.
FAILED - RETRYING: async_status <span class=o>(</span><span class=m>22</span> retries left<span class=o>)</span>.
FAILED - RETRYING: async_status <span class=o>(</span><span class=m>21</span> retries left<span class=o>)</span>.
FAILED - RETRYING: async_status <span class=o>(</span><span class=m>20</span> retries left<span class=o>)</span>.
FAILED - RETRYING: async_status <span class=o>(</span><span class=m>19</span> retries left<span class=o>)</span>.
FAILED - RETRYING: async_status <span class=o>(</span><span class=m>18</span> retries left<span class=o>)</span>.
FAILED - RETRYING: async_status <span class=o>(</span><span class=m>17</span> retries left<span class=o>)</span>.
FAILED - RETRYING: async_status <span class=o>(</span><span class=m>16</span> retries left<span class=o>)</span>.
FAILED - RETRYING: async_status <span class=o>(</span><span class=m>15</span> retries left<span class=o>)</span>.
FAILED - RETRYING: async_status <span class=o>(</span><span class=m>14</span> retries left<span class=o>)</span>.
FAILED - RETRYING: async_status <span class=o>(</span><span class=m>13</span> retries left<span class=o>)</span>.
FAILED - RETRYING: async_status <span class=o>(</span><span class=m>12</span> retries left<span class=o>)</span>.
FAILED - RETRYING: async_status <span class=o>(</span><span class=m>11</span> retries left<span class=o>)</span>.
changed: <span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span> <span class=o>=</span>&gt; <span class=o>{</span><span class=s2>&quot;ansible_job_id&quot;</span>: <span class=s2>&quot;965275577324.14846&quot;</span>, <span class=s2>&quot;attempts&quot;</span>: <span class=m>21</span>, <span class=s2>&quot;changed&quot;</span>: true, <span class=s2>&quot;cmd&quot;</span>: <span class=s2>&quot;sleep 100 &amp;&amp; hostname&quot;</span>, <span class=s2>&quot;delta&quot;</span>: <span class=s2>&quot;0:01:40.069235&quot;</span>, <span class=s2>&quot;end&quot;</span>: <span class=s2>&quot;2020-04-03 21:59:52.442879&quot;</span>, <span class=s2>&quot;finished&quot;</span>: <span class=m>1</span>, <span class=s2>&quot;rc&quot;</span>: <span class=m>0</span>, <span class=s2>&quot;start&quot;</span>: <span class=s2>&quot;2020-04-03 21:58:12.373644&quot;</span>, <span class=s2>&quot;stderr&quot;</span>: <span class=s2>&quot;&quot;</span>, <span class=s2>&quot;stderr_lines&quot;</span>: <span class=o>[]</span>, <span class=s2>&quot;stdout&quot;</span>: <span class=s2>&quot;node131&quot;</span>, <span class=s2>&quot;stdout_lines&quot;</span>: <span class=o>[</span><span class=s2>&quot;node131&quot;</span><span class=o>]}</span>
META: ran handlers
META: ran handlers

PLAY RECAP ********************************************************************************************************************************
<span class=m>192</span>.168.77.131             : <span class=nv>ok</span><span class=o>=</span><span class=m>4</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>2</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>0</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>   
</code></pre></div></p> <p>使用ansible来执行异步</p> <p><div class=highlight><pre><span></span><code><span class=c1># ansible 192.168.77.131 -B 3600 -P 0 -o -m shell -a &quot;sleep 30&quot; -vv</span>
ansible <span class=m>2</span>.9.6
  config <span class=nv>file</span> <span class=o>=</span> /etc/ansible/ansible.cfg
  configured module search <span class=nv>path</span> <span class=o>=</span> <span class=o>[</span>u<span class=s1>&#39;/root/.ansible/plugins/modules&#39;</span>, u<span class=s1>&#39;/usr/share/ansible/plugins/modules&#39;</span><span class=o>]</span>
  ansible python module <span class=nv>location</span> <span class=o>=</span> /usr/lib/python2.7/site-packages/ansible
  executable <span class=nv>location</span> <span class=o>=</span> /usr/bin/ansible
  python <span class=nv>version</span> <span class=o>=</span> <span class=m>2</span>.7.5 <span class=o>(</span>default, Aug  <span class=m>4</span> <span class=m>2017</span>, <span class=m>00</span>:39:18<span class=o>)</span> <span class=o>[</span>GCC <span class=m>4</span>.8.5 <span class=m>20150623</span> <span class=o>(</span>Red Hat <span class=m>4</span>.8.5-16<span class=o>)]</span>
Using /etc/ansible/ansible.cfg as config file
META: ran handlers
<span class=m>192</span>.168.77.131 <span class=p>|</span> <span class=nv>CHANGED</span> <span class=o>=</span>&gt; <span class=o>{</span><span class=s2>&quot;ansible_facts&quot;</span>: <span class=o>{</span><span class=s2>&quot;discovered_interpreter_python&quot;</span>: <span class=s2>&quot;/usr/bin/python&quot;</span><span class=o>}</span>, <span class=s2>&quot;ansible_job_id&quot;</span>: <span class=s2>&quot;71761724165.16525&quot;</span>, <span class=s2>&quot;changed&quot;</span>: true, <span class=s2>&quot;finished&quot;</span>: <span class=m>0</span>, <span class=s2>&quot;results_file&quot;</span>: <span class=s2>&quot;/root/.ansible_async/71761724165.16525&quot;</span>, <span class=s2>&quot;started&quot;</span>: <span class=m>1</span><span class=o>}</span>
META: ran handlers
META: ran handlers
</code></pre></div> 使用<code>async_status</code>来获取异步状态信息 <div class=highlight><pre><span></span><code><span class=c1># ansible 192.168.77.131 -m  async_status -a &quot;jid=71761724165.16525&quot;</span>
<span class=m>192</span>.168.77.131 <span class=p>|</span> <span class=nv>SUCCESS</span> <span class=o>=</span>&gt; <span class=o>{</span>
    <span class=s2>&quot;ansible_facts&quot;</span>: <span class=o>{</span>
        <span class=s2>&quot;discovered_interpreter_python&quot;</span>: <span class=s2>&quot;/usr/bin/python&quot;</span>
    <span class=o>}</span>, 
    <span class=s2>&quot;ansible_job_id&quot;</span>: <span class=s2>&quot;71761724165.16525&quot;</span>, 
    <span class=s2>&quot;changed&quot;</span>: false, 
    <span class=s2>&quot;finished&quot;</span>: <span class=m>0</span>, 
    <span class=s2>&quot;started&quot;</span>: <span class=m>1</span>
<span class=o>}</span>

<span class=c1># .... 等待任务执行完成</span>

<span class=c1># ansible 192.168.77.131 -m  async_status -a &quot;jid=71761724165.16525&quot;</span>
<span class=m>192</span>.168.77.131 <span class=p>|</span> <span class=nv>CHANGED</span> <span class=o>=</span>&gt; <span class=o>{</span>
    <span class=s2>&quot;ansible_facts&quot;</span>: <span class=o>{</span>
        <span class=s2>&quot;discovered_interpreter_python&quot;</span>: <span class=s2>&quot;/usr/bin/python&quot;</span>
    <span class=o>}</span>, 
    <span class=s2>&quot;ansible_job_id&quot;</span>: <span class=s2>&quot;71761724165.16525&quot;</span>, 
    <span class=s2>&quot;changed&quot;</span>: true, 
    <span class=s2>&quot;cmd&quot;</span>: <span class=s2>&quot;sleep 30&quot;</span>, 
    <span class=s2>&quot;delta&quot;</span>: <span class=s2>&quot;0:00:30.059717&quot;</span>, 
    <span class=s2>&quot;end&quot;</span>: <span class=s2>&quot;2020-04-03 22:09:37.777453&quot;</span>, 
    <span class=s2>&quot;finished&quot;</span>: <span class=m>1</span>, 
    <span class=s2>&quot;rc&quot;</span>: <span class=m>0</span>, 
    <span class=s2>&quot;start&quot;</span>: <span class=s2>&quot;2020-04-03 22:09:07.717736&quot;</span>, 
    <span class=s2>&quot;stderr&quot;</span>: <span class=s2>&quot;&quot;</span>, 
    <span class=s2>&quot;stderr_lines&quot;</span>: <span class=o>[]</span>, 
    <span class=s2>&quot;stdout&quot;</span>: <span class=s2>&quot;&quot;</span>, 
    <span class=s2>&quot;stdout_lines&quot;</span>: <span class=o>[]</span>
<span class=o>}</span>
</code></pre></div></p> <ul> <li>注意：在使用'command', 'win_command', 'shell', 'win_shell', 'raw'模块时，是不会返回信息的。</li> </ul> <p>限制并发运行的任务数量的同时运行多个异步任务</p> <div class=highlight><pre><span></span><code><span class=c1>#####################</span>
<span class=c1># main.yml</span>
<span class=c1>#####################</span>
<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Run items asynchronously in batch of two items</span>
  <span class=nt>vars</span><span class=p>:</span>
    <span class=nt>sleep_durations</span><span class=p>:</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">2</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">4</span>
      <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
    <span class=nt>durations</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>item</span><span class=nv> </span><span class=s>}}&quot;</span>
  <span class=nt>include_tasks</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">execute_batch.yml</span>
  <span class=nt>loop</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>sleep_durations</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>batch(2)</span><span class=nv> </span><span class=s>|</span><span class=nv> </span><span class=s>list</span><span class=nv> </span><span class=s>}}&quot;</span>

<span class=c1>#####################</span>
<span class=c1># execute_batch.yml</span>
<span class=c1>#####################</span>
<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Async sleeping for batched_items</span>
  <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">sleep {{ async_item }}</span>
  <span class=nt>async</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">45</span>
  <span class=nt>poll</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">0</span>
  <span class=nt>loop</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>durations</span><span class=nv> </span><span class=s>}}&quot;</span>
  <span class=nt>loop_control</span><span class=p>:</span>
    <span class=nt>loop_var</span><span class=p>:</span> <span class=s>&quot;async_item&quot;</span>
  <span class=nt>register</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">async_results</span>

<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Check sync status</span>
  <span class=nt>async_status</span><span class=p>:</span>
    <span class=nt>jid</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>async_result_item.ansible_job_id</span><span class=nv> </span><span class=s>}}&quot;</span>
  <span class=nt>loop</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>async_results.results</span><span class=nv> </span><span class=s>}}&quot;</span>
  <span class=nt>loop_control</span><span class=p>:</span>
    <span class=nt>loop_var</span><span class=p>:</span> <span class=s>&quot;async_result_item&quot;</span>
  <span class=nt>register</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">async_poll_results</span>
  <span class=nt>until</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">async_poll_results.finished</span>
  <span class=nt>retries</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">30</span>
</code></pre></div> <p>一个重启服务器的playbook <div class=highlight><pre><span></span><code><span class=nn>---</span>
<span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.77.131</span>
  <span class=nt>gather_facts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">no</span>
  <span class=nt>become</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>

  <span class=nt>tasks</span><span class=p>:</span>
   <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Check the uptime prior reboot</span>
     <span class=nt>shell</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">uptime</span>
     <span class=nt>register</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">UPTIME_PRE_REBOOT</span>

   <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">msg={{UPTIME_PRE_REBOOT.stdout}}</span>

   <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Reboot node and stop polling.</span>
     <span class=nt>shell</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">reboot</span>
     <span class=nt>async</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">10</span> <span class=c1># Do not care for 10 sec</span>
     <span class=nt>poll</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">0</span> <span class=c1># Fire &amp; Forget</span>

   <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">wait for host to finish reboot</span>
     <span class=nt>wait_for</span><span class=p>:</span>
      <span class=nt>port</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>(ansible_port|default(ansible_ssh_port))|default(22)</span><span class=nv> </span><span class=s>}}&quot;</span>
      <span class=nt>host</span><span class=p>:</span> <span class=s>&#39;{{</span><span class=nv> </span><span class=s>(ansible_ssh_host|default(ansible_host))|default(inventory_hostname)</span><span class=nv> </span><span class=s>}}&#39;</span>
      <span class=nt>search_regex</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">OpenSSH</span>
      <span class=nt>delay</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>  <span class=c1># Do not check for at least 10 sec</span>
     <span class=nt>connection</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">local</span>

   <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Check the uptime post reboot</span>
     <span class=nt>shell</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">uptime</span>
     <span class=nt>register</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">UPTIME_POST_REBOOT</span>

   <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">msg={{UPTIME_POST_REBOOT.stdout}}</span>
</code></pre></div></p> <h3 id=_5>异步任务的状态文件<a class=headerlink href=#_5 title="Permanent link">&para;</a></h3> <p>异步任务的状态文件以jid命名的方式存放在远端主机的用户目录下的.ansible_async目录，本次使用的是root连接远端，所以目录是/root/.ansible_async。</p> <p>查看状态文件</p> <div class=highlight><pre><span></span><code><span class=c1># cat /root/.ansible_async/71761724165.16525</span>
<span class=o>{</span><span class=s2>&quot;started&quot;</span>: <span class=m>1</span>, <span class=s2>&quot;finished&quot;</span>: <span class=m>0</span>, <span class=s2>&quot;ansible_job_id&quot;</span>: <span class=s2>&quot;71761724165.16525&quot;</span><span class=o>}</span>

<span class=c1># 任务结束后</span>

<span class=c1># cat /root/.ansible_async/71761724165.16525</span>
<span class=o>{</span><span class=s2>&quot;changed&quot;</span>: true, <span class=s2>&quot;end&quot;</span>: <span class=s2>&quot;2020-04-03 22:09:37.777453&quot;</span>, <span class=s2>&quot;stdout&quot;</span>: <span class=s2>&quot;&quot;</span>, <span class=s2>&quot;cmd&quot;</span>: <span class=s2>&quot;sleep 30&quot;</span>, <span class=s2>&quot;start&quot;</span>: <span class=s2>&quot;2020-04-03 22:09:07.717736&quot;</span>, <span class=s2>&quot;delta&quot;</span>: <span class=s2>&quot;0:00:30.059717&quot;</span>, <span class=s2>&quot;stderr&quot;</span>: <span class=s2>&quot;&quot;</span>, <span class=s2>&quot;rc&quot;</span>: <span class=m>0</span>, <span class=s2>&quot;invocation&quot;</span>: <span class=o>{</span><span class=s2>&quot;module_args&quot;</span>: <span class=o>{</span><span class=s2>&quot;warn&quot;</span>: true, <span class=s2>&quot;executable&quot;</span>: null, <span class=s2>&quot;_uses_shell&quot;</span>: true, <span class=s2>&quot;strip_empty_ends&quot;</span>: true, <span class=s2>&quot;_raw_params&quot;</span>: <span class=s2>&quot;sleep 30&quot;</span>, <span class=s2>&quot;removes&quot;</span>: null, <span class=s2>&quot;argv&quot;</span>: null, <span class=s2>&quot;creates&quot;</span>: null, <span class=s2>&quot;chdir&quot;</span>: null, <span class=s2>&quot;stdin_add_newline&quot;</span>: true, <span class=s2>&quot;stdin&quot;</span>: null<span class=o>}}}</span>
</code></pre></div> <h3 id=_6>异步任务的返回值<a class=headerlink href=#_6 title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=p>{</span>
    <span class=nt>&quot;ansible_facts&quot;</span><span class=p>:</span> <span class=p>{</span>
        <span class=nt>&quot;discovered_interpreter_python&quot;</span><span class=p>:</span> <span class=s2>&quot;/usr/bin/python&quot;</span>
    <span class=p>},</span>
    <span class=nt>&quot;ansible_job_id&quot;</span><span class=p>:</span> <span class=s2>&quot;662217446295.16055&quot;</span><span class=p>,</span>
    <span class=nt>&quot;changed&quot;</span><span class=p>:</span> <span class=kc>true</span><span class=p>,</span>
    <span class=nt>&quot;finished&quot;</span><span class=p>:</span> <span class=mi>0</span><span class=p>,</span>
    <span class=nt>&quot;results_file&quot;</span><span class=p>:</span> <span class=s2>&quot;/root/.ansible_async/662217446295.16055&quot;</span><span class=p>,</span>
    <span class=nt>&quot;started&quot;</span><span class=p>:</span> <span class=mi>1</span>
<span class=p>}</span>
</code></pre></div> <blockquote> <p>ansible_job_id 异步任务id， results_file异步任务的状态文件</p> </blockquote> <h3 id=_7>异步任务状态的返回值<a class=headerlink href=#_7 title="Permanent link">&para;</a></h3> <p>可通过 async_status 获取，async_status 是读取远端的异步任务状态文件来获得任务状态，如果async设置的时间太短，可能会导致获取不到状态文件，因为还没生成这个文件。</p> <p>执行中的返回值</p> <div class=highlight><pre><span></span><code><span class=o>{</span>
    <span class=s2>&quot;ansible_facts&quot;</span>: <span class=o>{</span>
        <span class=s2>&quot;discovered_interpreter_python&quot;</span>: <span class=s2>&quot;/usr/bin/python&quot;</span>
    <span class=o>}</span>, 
    <span class=s2>&quot;ansible_job_id&quot;</span>: <span class=s2>&quot;71761724165.16525&quot;</span>, 
    <span class=s2>&quot;changed&quot;</span>: false, 
    <span class=s2>&quot;finished&quot;</span>: <span class=m>0</span>, 
    <span class=s2>&quot;started&quot;</span>: <span class=m>1</span>
<span class=o>}</span>
</code></pre></div> <p>执行完成后的返回值</p> <div class=highlight><pre><span></span><code><span class=o>{</span>
    <span class=s2>&quot;ansible_facts&quot;</span>: <span class=o>{</span>
        <span class=s2>&quot;discovered_interpreter_python&quot;</span>: <span class=s2>&quot;/usr/bin/python&quot;</span>
    <span class=o>}</span>, 
    <span class=s2>&quot;ansible_job_id&quot;</span>: <span class=s2>&quot;71761724165.16525&quot;</span>, 
    <span class=s2>&quot;changed&quot;</span>: true, 
    <span class=s2>&quot;cmd&quot;</span>: <span class=s2>&quot;sleep 30&quot;</span>, 
    <span class=s2>&quot;delta&quot;</span>: <span class=s2>&quot;0:00:30.059717&quot;</span>, 
    <span class=s2>&quot;end&quot;</span>: <span class=s2>&quot;2020-04-03 22:09:37.777453&quot;</span>, 
    <span class=s2>&quot;finished&quot;</span>: <span class=m>1</span>, 
    <span class=s2>&quot;rc&quot;</span>: <span class=m>0</span>, 
    <span class=s2>&quot;start&quot;</span>: <span class=s2>&quot;2020-04-03 22:09:07.717736&quot;</span>, 
    <span class=s2>&quot;stderr&quot;</span>: <span class=s2>&quot;&quot;</span>, 
    <span class=s2>&quot;stderr_lines&quot;</span>: <span class=o>[]</span>, 
    <span class=s2>&quot;stdout&quot;</span>: <span class=s2>&quot;&quot;</span>, 
    <span class=s2>&quot;stdout_lines&quot;</span>: <span class=o>[]</span>
<span class=o>}</span>
</code></pre></div> <h2 id=_8>检查模式<a class=headerlink href=#_8 title="Permanent link">&para;</a></h2> <p>当ansible-playbook执行时加上<code>--check</code>选项时，它不会对远程系统做任何更改。支持检查模式的模块将报告它们将进行的更改，而不是进行更改。不支持检查模式的其他模块也将不采取任何操作，只是不报告它们可能做了哪些更改。</p> <p>执行例子</p> <div class=highlight><pre><span></span><code>ansible-playbook foo.yml --check 
</code></pre></div> <p>也可以在任务中使用检查模式</p> <div class=highlight><pre><span></span><code><span class=nt>tasks</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">this task will make changes to the system even in check mode</span>
    <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/something/to/run --even-in-check-mode</span>
    <span class=nt>check_mode</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">no</span>

  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">this task will always run under checkmode and not change the system</span>
    <span class=nt>lineinfile</span><span class=p>:</span>
        <span class=nt>line</span><span class=p>:</span> <span class=s>&quot;important</span><span class=nv> </span><span class=s>config&quot;</span>
        <span class=nt>dest</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/path/to/myconfig.conf</span>
        <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
    <span class=nt>check_mode</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
</code></pre></div> <p><code>ansible_check_mode</code>变量是用来存储当前是否是检查模式的布尔类型</p> <div class=highlight><pre><span></span><code><span class=nt>tasks</span><span class=p>:</span>

  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">this task will be skipped in check mode</span>
    <span class=nt>git</span><span class=p>:</span>
      <span class=nt>repo</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ssh://git@github.com/mylogin/hello.git</span>
      <span class=nt>dest</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/home/mylogin/hello</span>
    <span class=nt>when</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">not ansible_check_mode</span>

  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">this task will ignore errors in check mode</span>
    <span class=nt>git</span><span class=p>:</span>
      <span class=nt>repo</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ssh://git@github.com/mylogin/hello.git</span>
      <span class=nt>dest</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/home/mylogin/hello</span>
    <span class=nt>ignore_errors</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>ansible_check_mode</span><span class=nv> </span><span class=s>}}&quot;</span>
</code></pre></div> <p>diff模块</p> <p>ansible-playbook的<code>--diff</code>选项可与<code>--check</code>配合使用（如上详述），但也可以单独使用。 提供此标志且模块支持此标志时，Ansible将报告所做的更改，或者如果与<code>--check</code>一起使用，则将报告所做的更改。</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class=nt>tasks</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">debug.</span>
    <span class=nt>debug</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">msg=123</span>
    <span class=nt>check_mode</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">no</span>
  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">add hosts.</span>
    <span class=nt>lineinfile</span><span class=p>:</span>
      <span class=nt>line</span><span class=p>:</span> <span class=s>&quot;127.0.0.2</span><span class=nv> </span><span class=s>localhost&quot;</span>
      <span class=nt>dest</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/hosts</span>
      <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
      <span class=nt>check_mode</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">add hosts.</span>
    <span class=nt>lineinfile</span><span class=p>:</span>
      <span class=nt>line</span><span class=p>:</span> <span class=s>&quot;127.0.0.2</span><span class=nv> </span><span class=s>localhost&quot;</span>
      <span class=nt>dest</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/hosts</span>
      <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
      <span class=nt>diff</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">no</span>
</code></pre></div> <blockquote> <p>diff: no 禁止对比</p> </blockquote> <p>检查并对比更改</p> <div class=highlight><pre><span></span><code>ansible-playbook  foo.yml --check --diff
</code></pre></div> <h2 id=debug>debug 功能<a class=headerlink href=#debug title="Permanent link">&para;</a></h2> <p>Ansible把一个<code>debugger</code>作为<code>strategy</code>插件的一部分。此调试器使您能够作为任务进行调试，这个过程是阻塞运行的。但使用<code>debug</code>模块也可以调试变量或表达式，而不必阻塞playbook。</p> <p>有多种使用调试器的方法。</p> <h3 id=debugger>使用 debugger 关键字<a class=headerlink href=#debugger title="Permanent link">&para;</a></h3> <p>debugger提供几个值</p> <table> <thead> <tr> <th>可选值</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>always</td> <td>总是调用调试器，而不管结果如何</td> </tr> <tr> <td>never</td> <td>不管结果如何，都不要调用调试器</td> </tr> <tr> <td>on_failed</td> <td>只有在任务失败时才调用调试器</td> </tr> <tr> <td>on_unreachable</td> <td>只有在主机无法访问时才调用调试器</td> </tr> <tr> <td>on_skipped</td> <td>只有在任务被跳过时才调用调试器</td> </tr> </tbody> </table> <p>在play中使用</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Play</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">all</span>
  <span class=nt>debugger</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">on_skipped</span>
  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Execute a command</span>
      <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
      <span class=nt>when</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">False</span>
</code></pre></div> <p>在task中使用</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Execute a command</span>
  <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
  <span class=nt>debugger</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">on_failed</span>
</code></pre></div> <p>当play和task同时使用<code>debugger</code>时，task的生效</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Play</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">all</span>
  <span class=nt>debugger</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">never</span>
  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Execute a command</span>
      <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">false</span>
      <span class=nt>debugger</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">on_failed</span>
</code></pre></div> <h3 id=_9>配置或环境变量<a class=headerlink href=#_9 title="Permanent link">&para;</a></h3> <p>在<code>ansible.cfg</code>上配置</p> <div class=highlight><pre><span></span><code><span class=k>[defaults]</span>
<span class=na>enable_task_debugger</span> <span class=o>=</span> <span class=s>True</span>
</code></pre></div> <p>或者设置环境变量</p> <div class=highlight><pre><span></span><code><span class=nv>ANSIBLE_ENABLE_TASK_DEBUGGER</span><span class=o>=</span>True ansible-playbook -i hosts site.yml
</code></pre></div> <h3 id=strategy>使用 strategy 插件<a class=headerlink href=#strategy title="Permanent link">&para;</a></h3> <p>使用 <code>strategy</code> 插件<code>debug</code></p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">test</span>
  <span class=nt>strategy</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">debug</span>
  <span class=nt>tasks</span><span class=p>:</span>
  <span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div> <p>或者修改配置和环境变量</p> <div class=highlight><pre><span></span><code><span class=k>[defaults]</span>
<span class=na>strategy</span> <span class=o>=</span> <span class=s>debug</span>
</code></pre></div> <p>环境变量</p> <div class=highlight><pre><span></span><code><span class=nv>ANSIBLE_STRATEGY</span><span class=o>=</span>debug
</code></pre></div> <h3 id=debugger_1>调试 debugger<a class=headerlink href=#debugger_1 title="Permanent link">&para;</a></h3> <p>使用以下例子</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">192.168.77.131</span>
  <span class=nt>debugger</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">on_failed</span>
  <span class=nt>gather_facts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">no</span>
  <span class=nt>vars</span><span class=p>:</span>
    <span class=nt>var1</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">value1</span>
  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">wrong variable</span>
      <span class=nt>ping</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">data={{ wrong_var }}</span>
</code></pre></div> <p>以上playbook，在执行到错误的任务时，会进入debug模式下</p> <div class=highlight><pre><span></span><code><span class=c1># ansible-playbook debuger.yaml</span>

PLAY <span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span> *****************************************************************************************

TASK <span class=o>[</span>wrong variable<span class=o>]</span> *****************************************************************************************
fatal: <span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span>: FAILED! <span class=o>=</span>&gt; <span class=o>{</span><span class=s2>&quot;msg&quot;</span>: <span class=s2>&quot;The task includes an option with an undefined variable. The error was: &#39;wrong_var&#39; is undefined\n\nThe error appears to be in &#39;/etc/ansible/debuger.yaml&#39;: line 7, column 7, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n  tasks:\n    - name: wrong variable\n      ^ here\n&quot;</span><span class=o>}</span>
<span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span> TASK: wrong variable <span class=o>(</span>debug<span class=o>)</span>&gt; p result._result
<span class=o>{</span><span class=s1>&#39;_ansible_no_log&#39;</span>: False,
 <span class=s1>&#39;failed&#39;</span>: True,
 <span class=s1>&#39;msg&#39;</span>: u<span class=s2>&quot;The task includes an option with an undefined variable. The error was: &#39;wrong_var&#39; is undefined\n\nThe error appears to be in &#39;/etc/ansible/debuger.yaml&#39;: line 7, column 7, but may\nbe elsewhere in the file depending on the exact syntax problem.\n\nThe offending line appears to be:\n\n  tasks:\n    - name: wrong variable\n      ^ here\n&quot;</span><span class=o>}</span>
<span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span> TASK: wrong variable <span class=o>(</span>debug<span class=o>)</span>&gt; p task.args
<span class=o>{</span>u<span class=s1>&#39;data&#39;</span>: u<span class=s1>&#39;{{ wrong_var }}&#39;</span><span class=o>}</span>
<span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span> TASK: wrong variable <span class=o>(</span>debug<span class=o>)</span>&gt; task.args<span class=o>[</span><span class=s1>&#39;data&#39;</span><span class=o>]</span> <span class=o>=</span> <span class=s1>&#39;{{ var1 }}&#39;</span>
<span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span> TASK: wrong variable <span class=o>(</span>debug<span class=o>)</span>&gt; p task.args
<span class=o>{</span>u<span class=s1>&#39;data&#39;</span>: <span class=s1>&#39;{{ var1 }}&#39;</span><span class=o>}</span>
<span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span> TASK: wrong variable <span class=o>(</span>debug<span class=o>)</span>&gt; redo
ok: <span class=o>[</span><span class=m>192</span>.168.77.131<span class=o>]</span>

PLAY RECAP *****************************************************************************************
<span class=m>192</span>.168.77.131             : <span class=nv>ok</span><span class=o>=</span><span class=m>1</span>    <span class=nv>changed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>unreachable</span><span class=o>=</span><span class=m>0</span>    <span class=nv>failed</span><span class=o>=</span><span class=m>0</span>    <span class=nv>skipped</span><span class=o>=</span><span class=m>0</span>    <span class=nv>rescued</span><span class=o>=</span><span class=m>0</span>    <span class=nv>ignored</span><span class=o>=</span><span class=m>0</span>
</code></pre></div> <p>通过调试，我们使playbook以成功运行完毕。</p> <p><code>debugger</code>模式下的可用指令</p> <table> <thead> <tr> <th>指令</th> <th>说明</th> </tr> </thead> <tbody> <tr> <td>p</td> <td>显示此次失败的原因</td> </tr> <tr> <td>p task</td> <td>显示此次任务的名称</td> </tr> <tr> <td>p task.args</td> <td>显示模块的参数</td> </tr> <tr> <td>p task_vars</td> <td>显示任务的可用变量</td> </tr> <tr> <td>p host</td> <td>显示执行此次任务的主机</td> </tr> <tr> <td>p result</td> <td>显示此次任务的结果</td> </tr> <tr> <td>p vars</td> <td>显示当前的变量</td> </tr> <tr> <td>vars[key] = value</td> <td>更新vars中的值</td> </tr> <tr> <td>task.args[key] = value</td> <td>更新模块的参数。</td> </tr> <tr> <td>u(pdate_task)</td> <td>从原始任务数据结构和带有更新的task_vars的模板中重新创建任务</td> </tr> <tr> <td>r(edo)</td> <td>再次执行此任务</td> </tr> <tr> <td>c(ontinue)</td> <td>继续执行</td> </tr> <tr> <td>q(uit)</td> <td>退出debug模式</td> </tr> </tbody> </table> <h3 id=free>与<code>free</code>策略一起使用<a class=headerlink href=#free title="Permanent link">&para;</a></h3> <p>当<code>debugger</code>与<code>free</code>策略一起使用时，在调试器处于活动状态时，不会导致其他任务排队或执行。但使用<code>redo</code>时，可能回导致当前任务在其他任务之后执行</p> <h3 id=debug_1>使用 debug 模块<a class=headerlink href=#debug_1 title="Permanent link">&para;</a></h3> <p>在执行期间打印语句，使用<code>debug</code>模块可以调试变量或表达式，而不必阻塞playbook。</p> <p>打印自定义的信息</p> <div class=highlight><pre><span></span><code><span class=nt>tasks</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">msg=&quot;System {{ inventory_hostname }} has uuid {{ ansible_product_uuid  }}&quot;</span>
</code></pre></div> <p>调试变量</p> <div class=highlight><pre><span></span><code><span class=nt>tasks</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">var=result  verbosity=2</span>
</code></pre></div> <h2 id=_10>滚动执行<a class=headerlink href=#_10 title="Permanent link">&para;</a></h2> <p>默认情况下，Ansible会并行地管理一个剧本中引用的所有机器。对于滚动更新用例，可以使用<code>serial</code>关键字定义Ansible并行执行多少台主机</p> <div class=highlight><pre><span></span><code><span class=nn>---</span>
<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">test play</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">webservers</span>
  <span class=nt>serial</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">3</span>
  <span class=nt>gather_facts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">False</span>

  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">task one</span>
      <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">hostname</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">task two</span>
      <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">hostname</span>
</code></pre></div> <p>在上面的例子中，如果我们有100个主机，组“webservers”中的3个主机将完成playbook，然后再移动到接下来的3个主机。</p> <p>还可以使用百分比</p> <div class=highlight><pre><span></span><code><span class=nt>serial</span><span class=p>:</span> <span class=s>&quot;30%&quot;</span>
</code></pre></div> <p>从Ansible 2.2开始，可以指定一个列表作为批量执行的依据</p> <div class=highlight><pre><span></span><code><span class=nn>---</span>
<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">test play</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">webservers</span>
  <span class=nt>serial</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
</code></pre></div> <p>在上面的例子中，第一批执行将包含一个主机，下一批将包含5个主机，并且(如果还剩下任何主机)，接下来的每一批将包含10个主机，直到所有可用的主机都被使用。</p> <p>可以在列表中使用百分比</p> <div class=highlight><pre><span></span><code><span class=nn>---</span>
<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">test play</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">webservers</span>
  <span class=nt>serial</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=s>&quot;10%&quot;</span>
    <span class="p p-Indicator">-</span> <span class=s>&quot;20%&quot;</span>
    <span class="p p-Indicator">-</span> <span class=s>&quot;100%&quot;</span>
</code></pre></div> <p>也可以混合使用</p> <div class=highlight><pre><span></span><code><span class=nn>---</span>
<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">test play</span>
  <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">webservers</span>
  <span class=nt>serial</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">1</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">5</span>
    <span class="p p-Indicator">-</span> <span class=s>&quot;20%&quot;</span>
</code></pre></div> <h2 id=_11>指定最大失败数目<a class=headerlink href=#_11 title="Permanent link">&para;</a></h2> <p>默认情况下，只要组中有尚未失败的主机，Ansible将继续执行操作。 在一些情况下，例如利用上述滚动更新，可能希望在达到失败的特定阈值时中止任务。</p> <div class=highlight><pre><span></span><code><span class=nn>---</span>
<span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">webservers</span>
  <span class=nt>max_fail_percentage</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">30</span>
  <span class=nt>serial</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">10</span>
</code></pre></div> <p>在上面的示例中，如果组中的10台服务器中有3台以上发生故障，则将终止其余的操作。</p> <h2 id=_12>委托<a class=headerlink href=#_12 title="Permanent link">&para;</a></h2> <p>在任务上使用<code>delegate_to</code>关键字,可以将任务委托给指定主机去执行。</p> <div class=highlight><pre><span></span><code><span class=nn>---</span>
<span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">webservers</span>
  <span class=nt>serial</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">5</span>

  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">take out of load balancer pool</span>
      <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/usr/bin/take_out_of_pool {{ inventory_hostname }}</span>
      <span class=nt>delegate_to</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">127.0.0.1</span>

    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">actual steps would go here</span>
      <span class=nt>yum</span><span class=p>:</span>
        <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">acme-web-stack</span>
        <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">latest</span>

    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">add back to load balancer pool</span>
      <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/usr/bin/add_back_to_pool {{ inventory_hostname }}</span>
      <span class=nt>delegate_to</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">127.0.0.1</span>
</code></pre></div> <p><code>delegate_to: 127.0.0.1</code> 是将任务委派到ansible本地去执行，你可以使用简写的<code>local_action</code> 去执行</p> <div class=highlight><pre><span></span><code><span class=nn>---</span>
<span class=c1># ...</span>

  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">take out of load balancer pool</span>
      <span class=nt>local_action</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">command /usr/bin/take_out_of_pool {{ inventory_hostname }}</span>

<span class=c1># ...</span>

    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">add back to load balancer pool</span>
      <span class=nt>local_action</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">command /usr/bin/add_back_to_pool {{ inventory_hostname }}</span>
</code></pre></div> <p>一个例子</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">db_servers</span>
  <span class=nt>tasks</span><span class=p>:</span>
  <span class="p p-Indicator">-</span>  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ifconfig</span>
     <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">fconfig</span>
     <span class=nt>delegate_to</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">127.0.0.1</span>

  <span class="p p-Indicator">-</span>  <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ifconfig</span>
     <span class=nt>local_action</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">command ifconfig</span>

<span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">app_servers</span>
  <span class=nt>tasks</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">gather facts from db servers</span>
    <span class=nt>setup</span><span class=p>:</span>
    <span class=nt>delegate_to</span><span class=p>:</span> <span class=s>&quot;{{item}}&quot;</span>
    <span class=nt>delegate_facts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
    <span class=nt>with_items</span><span class=p>:</span>  <span class=s>&quot;{{groups[&#39;dbservers&#39;]}}&quot;</span>
</code></pre></div> <blockquote> <p>delegate_facts 指定收集委托主机的facts数据</p> </blockquote> <p>以上将为<code>dbservers</code>组中的机器收集<code>facts</code>，并将<code>facts</code>分配给这些机器，而不是<code>app_servers</code>。</p> <h2 id=_13>任务只运行一次<a class=headerlink href=#_13 title="Permanent link">&para;</a></h2> <p>通过在任务上配置<code>run_once</code>来实现当前任务在<code>play</code>中只执行一次</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>tasks</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ifconfig</span>
    <span class=nt>run_once</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>
</code></pre></div> <p>上面的例子，将只会在第一个执行主机上执行，其余的主机则不执行。</p> <p>有点类似于使用when条件判断</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/opt/application/upgrade_db.py</span>
  <span class=nt>when</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">inventory_hostname == webservers[0]</span>
</code></pre></div> <h2 id=_14>本地执行<a class=headerlink href=#_14 title="Permanent link">&para;</a></h2> <p>为playbook指定<code>connection=local</code>将会使任务在本地执行，而不是使用ssh连接远端。</p> <p>执行playbook</p> <div class=highlight><pre><span></span><code>ansible-playbook  playbook.yml --connection<span class=o>=</span><span class=nb>local</span>
</code></pre></div> <p>在play中指定</p> <div class=highlight><pre><span></span><code><span class=nn>---</span>
<span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">127.0.0.1</span>
  <span class=nt>connection</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">local</span>
</code></pre></div> <h2 id=_15>设置环境变量<a class=headerlink href=#_15 title="Permanent link">&para;</a></h2> <p>为运行程序指定环境变量，需指定<code>environment</code>关键字</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>tasks</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>apt</span><span class=p>:</span>  <span class="l l-Scalar l-Scalar-Plain">name=cobbler state=installed</span>
    <span class=nt>environment</span><span class=p>:</span>
      <span class=nt>http_proxy</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">http://proxy.example.com:8080</span>
      <span class=nt>PATH</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/var/local/nvm/versions/node/v4.2.1/bin:{{  ansible_env.PATH }}</span>
</code></pre></div> <p>也可以在play级别使用</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">testhost</span>
  <span class=nt>roles</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">php</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">nginx</span>
  <span class=nt>environment</span><span class=p>:</span>
    <span class=nt>http_proxy</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">http://proxy.example.com:8080</span>
</code></pre></div> <h2 id=_16>错误处理<a class=headerlink href=#_16 title="Permanent link">&para;</a></h2> <h3 id=_17>忽略错误<a class=headerlink href=#_17 title="Permanent link">&para;</a></h3> <p><code>ignore_errors</code> 模块可以在任务执行错误时，忽略错误并继续执行任务。</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>tasks</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/bin/false</span>
    <span class=nt>ignore_errors</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">true</span>

  <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">msg=&quot;false&quot;</span>
</code></pre></div> <h3 id=_18>重置无法访问的主机<a class=headerlink href=#_18 title="Permanent link">&para;</a></h3> <p>连接远端主机失败时，ansible会将主机设置为不可到达，这将从运行的活动主机列表中删除它们。要从这些问题中恢复，需执行下列动作恢复主机。</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span>  <span class=nt>meta</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">clear_host_errors</span>
</code></pre></div> <h3 id=handlers>即使任务失败，handlers也执行<a class=headerlink href=#handlers title="Permanent link">&para;</a></h3> <p>以下3中方法均可使用</p> <ul> <li>命令行加上<code>--force-handlers</code> 参数</li> <li>配置文件加上 <code>force_handlers = True</code></li> <li>playbook里设置 <code>force_handlers: True</code></li> </ul> <h3 id=_19>控制任务失败<a class=headerlink href=#_19 title="Permanent link">&para;</a></h3> <p>使用<code>failed_when</code>选项时，当条件为真时，可使当前任务以失败返回</p> <p>您可以通过在命令的输出中搜索一个单词或短语来检查是否命令执行是否失败</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Fail task when the command error output prints FAILED</span>
  <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/usr/bin/example-command -x -y -z</span>
  <span class=nt>register</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">command_result</span>
  <span class=nt>failed_when</span><span class=p>:</span> <span class=s>&quot;&#39;FAILED&#39;</span><span class=nv> </span><span class=s>in</span><span class=nv> </span><span class=s>command_result.stderr&quot;</span>
</code></pre></div> <p>或者根据返回值</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Fail task when both files are identical</span>
  <span class=nt>raw</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">diff foo/file1 bar/file2</span>
  <span class=nt>register</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">diff_cmd</span>
  <span class=nt>failed_when</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">diff_cmd.rc == 0 or diff_cmd.rc &gt;= 2</span>
</code></pre></div> <p>在以前的版本中，可以使用以下完成上述操作</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">this command prints FAILED when it fails</span>
  <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/usr/bin/example-command -x -y -z</span>
  <span class=nt>register</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">command_result</span>
  <span class=nt>ignore_errors</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>

<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">fail the play if the previous command did not succeed</span>
  <span class=nt>fail</span><span class=p>:</span>
    <span class=nt>msg</span><span class=p>:</span> <span class=s>&quot;the</span><span class=nv> </span><span class=s>command</span><span class=nv> </span><span class=s>failed&quot;</span>
  <span class=nt>when</span><span class=p>:</span> <span class=s>&quot;&#39;FAILED&#39;</span><span class=nv> </span><span class=s>in</span><span class=nv> </span><span class=s>command_result.stderr&quot;</span>
</code></pre></div> <p>可以使用多个并行条件，这些条件之间是<code>and</code>关系</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Check if a file exists in temp and fail task if it does</span>
  <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ls /tmp/this_should_not_be_here</span>
  <span class=nt>register</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">result</span>
  <span class=nt>failed_when</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">result.rc == 0</span>
    <span class="p p-Indicator">-</span> <span class=s>&#39;&quot;No</span><span class=nv> </span><span class=s>such&quot;</span><span class=nv> </span><span class=s>not</span><span class=nv> </span><span class=s>in</span><span class=nv> </span><span class=s>result.stdout&#39;</span>
</code></pre></div> <p>使用<code>or</code>条件</p> <div class=highlight><pre><span></span><code><span class=nt>failed_when</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">result.rc == 0 or &quot;No such&quot; not in result.stdout</span>
</code></pre></div> <p>如果一行写不下，可以使用多行表示</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">example of many failed_when conditions with OR</span>
  <span class=nt>shell</span><span class=p>:</span> <span class=s>&quot;./myBinary&quot;</span>
  <span class=nt>register</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">ret</span>
  <span class=nt>failed_when</span><span class=p>:</span> <span class="p p-Indicator">&gt;</span>
    <span class=no>(&quot;No such file or directory&quot; in ret.stdout) or</span>
    <span class=no>(ret.stderr != &#39;&#39;) or</span>
    <span class=no>(ret.rc == 10)</span>
</code></pre></div> <h3 id=changed>更改任务changed状态<a class=headerlink href=#changed title="Permanent link">&para;</a></h3> <p>指定<code>changed_when</code> 条件时，当条件为真，任务的<code>changed</code>为真，即表示当前任务做了更改。</p> <div class=highlight><pre><span></span><code><span class=nt>tasks</span><span class=p>:</span>

  <span class="p p-Indicator">-</span> <span class=nt>shell</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/usr/bin/billybass --mode=&quot;take me to the river&quot;</span>
    <span class=nt>register</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">bass_result</span>
    <span class=nt>changed_when</span><span class=p>:</span> <span class=s>&quot;bass_result.rc</span><span class=nv> </span><span class=s>!=</span><span class=nv> </span><span class=s>2&quot;</span>

  <span class=c1># this will never report &#39;changed&#39; status</span>
  <span class="p p-Indicator">-</span> <span class=nt>shell</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">wall &#39;beep&#39;</span>
    <span class=nt>changed_when</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">False</span>
</code></pre></div> <p>使用多个条件</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/bin/fake_command</span>
  <span class=nt>register</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">result</span>
  <span class=nt>ignore_errors</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>
  <span class=nt>changed_when</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=s>&#39;&quot;ERROR&quot;</span><span class=nv> </span><span class=s>in</span><span class=nv> </span><span class=s>result.stderr&#39;</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">result.rc == 2</span>
</code></pre></div> <h3 id=_20>出现错误时立即中断执行<a class=headerlink href=#_20 title="Permanent link">&para;</a></h3> <p>使用<code>any_errors_fatal</code>选项时，只要playbook中出现一个错误任务,ansible立即停止运行。已保证所有任务的正确运行。</p> <div class=highlight><pre><span></span><code><span class=nn>---</span>
<span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">load_balancers_dc_a</span>
  <span class=nt>any_errors_fatal</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">True</span>

  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class=s>&#39;shutting</span><span class=nv> </span><span class=s>down</span><span class=nv> </span><span class=s>datacenter</span><span class=nv> </span><span class=s>[</span><span class=nv> </span><span class=s>A</span><span class=nv> </span><span class=s>]&#39;</span>
      <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/usr/bin/disable-dc</span>

<span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">frontends_dc_a</span>

  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class=s>&#39;stopping</span><span class=nv> </span><span class=s>service&#39;</span>
      <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/usr/bin/stop-software</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class=s>&#39;updating</span><span class=nv> </span><span class=s>software&#39;</span>
      <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/usr/bin/upgrade-software</span>

<span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">load_balancers_dc_a</span>

  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class=s>&#39;Starting</span><span class=nv> </span><span class=s>datacenter</span><span class=nv> </span><span class=s>[</span><span class=nv> </span><span class=s>A</span><span class=nv> </span><span class=s>]&#39;</span>
      <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/usr/bin/enable-dc</span>
</code></pre></div> <h3 id=blocks>使用blocks<a class=headerlink href=#blocks title="Permanent link">&para;</a></h3> <p>使用<code>blocks</code>的<code>rescue</code>来实现对错误任务的处理</p> <div class=highlight><pre><span></span><code><span class=nt>tasks</span><span class=p>:</span>
<span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">Handle the error</span>
  <span class=nt>block</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span>
        <span class=nt>msg</span><span class=p>:</span> <span class=s>&#39;I</span><span class=nv> </span><span class=s>execute</span><span class=nv> </span><span class=s>normally&#39;</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">i force a failure</span>
      <span class=nt>command</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/bin/false</span>
    <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span>
        <span class=nt>msg</span><span class=p>:</span> <span class=s>&#39;I</span><span class=nv> </span><span class=s>never</span><span class=nv> </span><span class=s>execute,</span><span class=nv> </span><span class=s>due</span><span class=nv> </span><span class=s>to</span><span class=nv> </span><span class=s>the</span><span class=nv> </span><span class=s>above</span><span class=nv> </span><span class=s>task</span><span class=nv> </span><span class=s>failing,</span><span class=nv> </span><span class=s>:-(&#39;</span>
  <span class=nt>rescue</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span>
        <span class=nt>msg</span><span class=p>:</span> <span class=s>&#39;I</span><span class=nv> </span><span class=s>caught</span><span class=nv> </span><span class=s>an</span><span class=nv> </span><span class=s>error,</span><span class=nv> </span><span class=s>can</span><span class=nv> </span><span class=s>do</span><span class=nv> </span><span class=s>stuff</span><span class=nv> </span><span class=s>here</span><span class=nv> </span><span class=s>to</span><span class=nv> </span><span class=s>fix</span><span class=nv> </span><span class=s>it,</span><span class=nv> </span><span class=s>:-)&#39;</span>
</code></pre></div> <h2 id=yaml>YAML 语法<a class=headerlink href=#yaml title="Permanent link">&para;</a></h2> <p>YAML 语法见<a href=/basic/Reference/Yaml/ >详细介绍</a></p> <h2 id=prompts>Prompts: 运行时，提示输入内容<a class=headerlink href=#prompts title="Permanent link">&para;</a></h2> <p>在运行playbook时，您可能希望提示用户输入某些内容，可以通过<code>vars_prompt</code>实现这一点。</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">test</span>
  <span class=nt>gather_facts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">no</span>
  <span class=nt>vars_prompt</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class=s>&quot;name&quot;</span>
      <span class=nt>prompt</span><span class=p>:</span> <span class=s>&quot;what</span><span class=nv> </span><span class=s>is</span><span class=nv> </span><span class=s>your</span><span class=nv> </span><span class=s>name?&quot;</span>
      <span class=nt>default</span><span class=p>:</span> <span class=s>&quot;user&quot;</span>
      <span class=nt>private</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
      <span class=nt>confirm</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>

  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">msg={{ name }}</span>
</code></pre></div> <p><code>vars_prompt</code>的参数</p> <ul> <li>name: 定义变量名称，即输入的内容赋值给此变量</li> <li>prompt：输入得提示信息</li> <li>default： 输入的默认值，没有输入任何内容的时候，把此值赋值给变量</li> <li>private：是否隐藏输入得内容</li> <li>confirm：是否要再次确认输入</li> <li>unsafe: 不校验输入的字符串，如果输入特殊字符，可开启此选项</li> </ul> <p>如果安装了<code>Passlib</code>, <code>vars_prompt</code>还可以对输入的值进行加密</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">test</span>
  <span class=nt>gather_facts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">no</span>
  <span class=nt>vars_prompt</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>name</span><span class=p>:</span> <span class=s>&quot;pass&quot;</span>
      <span class=nt>prompt</span><span class=p>:</span> <span class=s>&quot;Enter</span><span class=nv> </span><span class=s>password2&quot;</span>
      <span class=nt>private</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
      <span class=nt>encrypt</span><span class=p>:</span> <span class=s>&quot;sha512_crypt&quot;</span>
      <span class=nt>confirm</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">yes</span>
      <span class=nt>salt_size</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">7</span>

  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">msg={{ pass }}</span>
</code></pre></div> <p>可以使用的加密方案</p> <ul> <li><em>des_crypt</em> - DES Crypt</li> <li><em>bsdi_crypt</em> - BSDi Crypt</li> <li><em>bigcrypt</em> - BigCrypt</li> <li><em>crypt16</em> - Crypt16</li> <li><em>md5_crypt</em> - MD5 Crypt</li> <li><em>bcrypt</em> - BCrypt</li> <li><em>sha1_crypt</em> - SHA-1 Crypt</li> <li><em>sun_md5_crypt</em> - Sun MD5 Crypt</li> <li><em>sha256_crypt</em> - SHA-256 Crypt</li> <li><em>sha512_crypt</em> - SHA-512 Crypt</li> <li><em>apr_md5_crypt</em> - Apache’s MD5-Crypt variant</li> <li><em>phpass</em> - PHPass’ Portable Hash</li> <li><em>pbkdf2_digest</em> - Generic PBKDF2 Hashes</li> <li><em>cta_pbkdf2_sha1</em> - Cryptacular’s PBKDF2 hash</li> <li><em>dlitz_pbkdf2_sha1</em> - Dwayne Litzenberger’s PBKDF2 hash</li> <li><em>scram</em> - SCRAM Hash</li> <li><em>bsd_nthash</em> - FreeBSD’s MCF-compatible nthash encoding</li> </ul> <h2 id=_21>标记<a class=headerlink href=#_21 title="Permanent link">&para;</a></h2> <p>如果你有一个大型剧本，但你只希望运行它的一个特定的部分，而不是运行剧本中的所有任务。这时候，你可以为运行的任务指定一个共同的<code>tags</code></p> <h3 id=_22>标记任务<a class=headerlink href=#_22 title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=nt>tasks</span><span class=p>:</span>
<span class="p p-Indicator">-</span> <span class=nt>yum</span><span class=p>:</span>
    <span class=nt>name</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">httpd</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">memcached</span>
    <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">present</span>
  <span class=nt>tags</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">packages</span>

<span class="p p-Indicator">-</span> <span class=nt>template</span><span class=p>:</span>
    <span class=nt>src</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">templates/src.j2</span>
    <span class=nt>dest</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/etc/foo.conf</span>
  <span class=nt>tags</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">configuration</span>
</code></pre></div> <blockquote> <p>标签名称可以重名</p> </blockquote> <p>显示playbook中的所有标记任务</p> <div class=highlight><pre><span></span><code>ansible-playbook  example.yml --list-tags
</code></pre></div> <p>执行所有标记名称为packages和configuration的任务</p> <div class=highlight><pre><span></span><code>ansible-playbook  example.yml --tags <span class=s2>&quot;configuration,packages&quot;</span>
</code></pre></div> <p>跳过所有标记名称为configuration的任务</p> <div class=highlight><pre><span></span><code>ansible-playbook  example.yml --skip-tags <span class=s2>&quot;configuration&quot;</span>
</code></pre></div> <h3 id=playbook>标记playbook<a class=headerlink href=#playbook title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">all</span>
  <span class=nt>tags</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">bar</span>
  <span class=nt>tasks</span><span class=p>:</span>
   <span class="l l-Scalar l-Scalar-Plain">...</span>

<span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">all</span>
  <span class=nt>tags</span><span class=p>:</span> <span class="p p-Indicator">[</span><span class=s>&#39;foo&#39;</span><span class="p p-Indicator">]</span>
  <span class=nt>tasks</span><span class=p>:</span>
  <span class="l l-Scalar l-Scalar-Plain">...</span>
</code></pre></div> <blockquote> <p>play里的所有tasks将会继承play的tags</p> </blockquote> <h3 id=role>标记role<a class=headerlink href=#role title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>roles</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class="p p-Indicator">{</span><span class=nt> role</span><span class=p>:</span> <span class=nv>webserver</span><span class="p p-Indicator">,</span><span class=nt> port</span><span class=p>:</span> <span class=nv>5000</span><span class="p p-Indicator">,</span><span class=nt> tags</span><span class=p>:</span> <span class="p p-Indicator">[</span>  <span class=s>&#39;web&#39;</span><span class="p p-Indicator">,</span> <span class=s>&#39;foo&#39;</span> <span class="p p-Indicator">]</span> <span class="p p-Indicator">}</span>
</code></pre></div> <blockquote> <p>role里的tasks将会继承role的tags</p> </blockquote> <h3 id=_23>标记包含<a class=headerlink href=#_23 title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>import_role</span><span class=p>:</span>
    <span class=nt>name</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">myrole</span>
  <span class=nt>tags</span><span class=p>:</span> <span class="p p-Indicator">[</span> <span class=nv>web</span><span class="p p-Indicator">,</span> <span class=nv>foo</span> <span class="p p-Indicator">]</span>

<span class="p p-Indicator">-</span> <span class=nt>import_tasks</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">foo.yml</span>
  <span class=nt>tags</span><span class=p>:</span> <span class="p p-Indicator">[</span> <span class=nv>web</span><span class="p p-Indicator">,</span> <span class=nv>foo</span> <span class="p p-Indicator">]</span>
</code></pre></div> <blockquote> <p>包含的role和tasks中的任务将会继承tags，动态包含则不继承tag</p> </blockquote> <h3 id=_24>特殊标记<a class=headerlink href=#_24 title="Permanent link">&para;</a></h3> <p>使用<code>always</code>标签可以始终运行标记的任务</p> <div class=highlight><pre><span></span><code><span class=nt>tasks</span><span class=p>:</span>
<span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span>
    <span class=nt>msg</span><span class=p>:</span> <span class=s>&quot;Always</span><span class=nv> </span><span class=s>runs&quot;</span>
  <span class=nt>tags</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">always</span>

<span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span>
    <span class=nt>msg</span><span class=p>:</span> <span class=s>&quot;runs</span><span class=nv> </span><span class=s>when</span><span class=nv> </span><span class=s>you</span><span class=nv> </span><span class=s>use</span><span class=nv> </span><span class=s>tag1&quot;</span>
  <span class=nt>tags</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class="l l-Scalar l-Scalar-Plain">tag1</span>
</code></pre></div> <p>还有另外4个特殊关键字用于标签，</p> <ul> <li><code>never</code> 阻止任务运行</li> <li><code>tagged</code> 仅运行已标记</li> <li><code>untagged</code> 运行只有未标记</li> <li><code>all</code>运行所有任务</li> </ul> <p>默认情况下ansible运行就像指定了<code>-tags all</code></p> <h2 id=vault>Vault 加密<a class=headerlink href=#vault title="Permanent link">&para;</a></h2> <p>Vault 加密使用方法见<a href=/basic/Reference/Vaults/ >详细介绍</a></p> <h2 id=_25>从某个任务开始执行<a class=headerlink href=#_25 title="Permanent link">&para;</a></h2> <p>为ansible-playbook指定<code>--start-at-task</code>，就可以从这个任务开始执行</p> <div class=highlight><pre><span></span><code>ansible-playbook  playbook.yml --start-at-task<span class=o>=</span><span class=s2>&quot;install packages&quot;</span>
</code></pre></div> <h2 id=_26>一步一步的执行<a class=headerlink href=#_26 title="Permanent link">&para;</a></h2> <p>ansible也可以一步一步交互的执行，执行每一步都需要确认是否继续</p> <div class=highlight><pre><span></span><code>ansible-playbook  playbook.yml --step
</code></pre></div> <h2 id=_27>模块默认值<a class=headerlink href=#_27 title="Permanent link">&para;</a></h2> <p>你可以为多个相同的模块指定默认值,而不必重复填写。</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class=nt>module_defaults</span><span class=p>:</span>
    <span class=nt>file</span><span class=p>:</span>
      <span class=nt>owner</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
      <span class=nt>group</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">root</span>
      <span class=nt>mode</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">0755</span>
  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>file</span><span class=p>:</span>
        <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">touch</span>
        <span class=nt>path</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/file1</span>
    <span class="p p-Indicator">-</span> <span class=nt>file</span><span class=p>:</span>
        <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">touch</span>
        <span class=nt>path</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/file2</span>
    <span class="p p-Indicator">-</span> <span class=nt>file</span><span class=p>:</span>
        <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">touch</span>
        <span class=nt>path</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/file3</span>
</code></pre></div> <p>可以在play、block和task级别使用module_defaults属性。</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>block</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span>
        <span class=nt>msg</span><span class=p>:</span> <span class=s>&quot;a</span><span class=nv> </span><span class=s>different</span><span class=nv> </span><span class=s>message&quot;</span>
  <span class=nt>module_defaults</span><span class=p>:</span>
    <span class=nt>debug</span><span class=p>:</span>
      <span class=nt>msg</span><span class=p>:</span> <span class=s>&quot;a</span><span class=nv> </span><span class=s>default</span><span class=nv> </span><span class=s>message&quot;</span>

<span class="p p-Indicator">-</span> <span class=nt>file</span><span class=p>:</span>
    <span class=nt>state</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">touch</span>
    <span class=nt>path</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">/tmp/file1</span>
  <span class=nt>module_defaults</span><span class=p>:</span>
    <span class=nt>file</span><span class=p>:</span> <span class="p p-Indicator">{}</span>
</code></pre></div> <p>在playbook中，您可以为整个模块组设置模块默认值，例如设置一个公共AWS区域。</p> <div class=highlight><pre><span></span><code><span class=c1># example_play.yml</span>
<span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">localhost</span>
  <span class=nt>module_defaults</span><span class=p>:</span>
    <span class=nt>group/aws</span><span class=p>:</span>
      <span class=nt>region</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">us-west-2</span>
  <span class=nt>tasks</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>aws_s3_bucket_info</span><span class=p>:</span>
  <span class=c1># now the region is shared between both info modules</span>
  <span class="p p-Indicator">-</span> <span class=nt>ec2_ami_info</span><span class=p>:</span>
      <span class=nt>filters</span><span class=p>:</span>
        <span class=nt>name</span><span class=p>:</span> <span class=s>&#39;RHEL*7.5*&#39;</span>
</code></pre></div> <p>可用于group的模块</p> <table> <thead> <tr> <th>Group</th> <th>Purpose</th> <th>Ansible Version</th> </tr> </thead> <tbody> <tr> <td>aws</td> <td>Amazon Web Services</td> <td>2.7</td> </tr> <tr> <td>azure</td> <td>Azure</td> <td>2.7</td> </tr> <tr> <td>gcp</td> <td>Google Cloud Platform</td> <td>2.7</td> </tr> <tr> <td>k8s</td> <td>Kubernetes</td> <td>2.8</td> </tr> <tr> <td>os</td> <td>OpenStack</td> <td>2.8</td> </tr> </tbody> </table> <h2 id=_28>等待<a class=headerlink href=#_28 title="Permanent link">&para;</a></h2> <p>使用<code>wait_for</code>模块，可以等待任务执行完毕后，才可继续执行后续的任务。</p> <p>等待端口可用,才能继续执行任务</p> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>wait_for</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">port=8000 delay=10</span>
</code></pre></div> <p>等待直到锁定文件被删除</p> <div class=highlight><pre><span></span><code><span class=nt>wait_for</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">path=/var/lock/file.lock state=absent</span>
</code></pre></div> <h2 id=playbook_1>Playbook 关键字<a class=headerlink href=#playbook_1 title="Permanent link">&para;</a></h2> <p>Playbook 可用的关键字见<a href=basic/Reference/Keywords/ >详细列表</a></p> <h2 id=lookup>lookup 插件<a class=headerlink href=#lookup title="Permanent link">&para;</a></h2> <p><code>lookup</code>插件允许访问外部数据源。与所有模板一样，这些插件是在Ansible control节点上执行的。</p> <h3 id=file>使用 <code>file</code> 获取文件内容<a class=headerlink href=#file title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=nn>---</span>

<span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">all</span>
  <span class=nt>vars</span><span class=p>:</span>
     <span class=nt>contents</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>lookup(&#39;file&#39;,</span><span class=nv>  </span><span class=s>&#39;/etc/foo.txt&#39;)</span><span class=nv> </span><span class=s>}}&quot;</span>

  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">msg=&quot;the value of foo.txt is {{  contents }}&quot;</span>
</code></pre></div> <h3 id=env>使用 <code>env</code> 获取变量<a class=headerlink href=#env title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=nn>---</span>

<span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">all</span>
  <span class=nt>vars</span><span class=p>:</span>
    <span class=nt>local_home</span><span class=p>:</span> <span class=s>&quot;{{</span><span class=nv> </span><span class=s>lookup(&#39;env&#39;,&#39;HOME&#39;)</span><span class=nv>  </span><span class=s>}}&quot;</span>
  <span class=nt>tasks</span><span class=p>:</span>
    <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">var=local_home</span>
</code></pre></div> <h3 id=password>使用 <code>password</code> 生成密码字符串<a class=headerlink href=#password title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code><span class=nn>---</span>
<span class="p p-Indicator">-</span> <span class=nt>hosts</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">all</span>

  <span class=nt>tasks</span><span class=p>:</span>
    <span class=c1>#  使用只有ascii字母且长度为8的随机密码创建一个mysql用户:</span>
    <span class="p p-Indicator">-</span> <span class=nt>mysql_user</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">name={{ client  }}</span>
                  <span class="l l-Scalar l-Scalar-Plain">password=&quot;{{  lookup(&#39;password&#39;, &#39;/tmp/passwordfile chars=ascii_letters length=8&#39;) }}&quot;</span>
                  <span class="l l-Scalar l-Scalar-Plain">priv={{ client }}_{{  tier }}_{{ role }}.*:ALL</span>

    <span class=c1># 使用只有数字的随机密码创建一个mysql用户:</span>
    <span class="p p-Indicator">-</span> <span class=nt>mysql_user</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">name={{ client  }}</span>
                  <span class="l l-Scalar l-Scalar-Plain">password=&quot;{{  lookup(&#39;password&#39;, &#39;/tmp/passwordfile chars=digits&#39;) }}&quot;</span>
                  <span class="l l-Scalar l-Scalar-Plain">priv={{ client }}_{{  tier }}_{{ role }}.*:ALL</span>

    <span class=c1># 使用许多不同的字符集使用随机密码创建一个mysql用户：</span>
    <span class="p p-Indicator">-</span> <span class=nt>mysql_user</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">name={{ client  }}</span>
                  <span class="l l-Scalar l-Scalar-Plain">password=&quot;{{  lookup(&#39;password&#39;, &#39;/tmp/passwordfile  chars=ascii_letters,digits,hexdigits,punctuation&#39;) }}&quot;</span>
                  <span class="l l-Scalar l-Scalar-Plain">priv={{ client }}_{{  tier }}_{{ role }}.*:ALL</span>
</code></pre></div> <p>如果文件已存在，则不会向其写入任何数据。 如果文件有内容，那些内容将作为密码读入。 空文件导致密码以空字符串返回。</p> <h3 id=csvfile-csv>使用 <code>csvfile</code> 读取csv文件<a class=headerlink href=#csvfile-csv title="Permanent link">&para;</a></h3> <div class=highlight><pre><span></span><code># f.csv 

Symbol,Atomic  Number,Atomic Mass
H,1,1.008
He,2,4.0026
Li,3,6.94
Be,4,9.012
B,5,10.81
</code></pre></div> <div class=highlight><pre><span></span><code><span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span>  <span class="l l-Scalar l-Scalar-Plain">msg=&quot;The atomic number of Lithium is {{ lookup(&#39;csvfile&#39;, &#39;Li  file=elements.csv delimiter=,&#39;) }}&quot;</span>
<span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span>  <span class="l l-Scalar l-Scalar-Plain">msg=&quot;The atomic mass of Lithium is {{ lookup(&#39;csvfile&#39;, &#39;Li  file=elements.csv delimiter=, col=2&#39;) }}&quot;</span>
</code></pre></div> <p>参数描述</p> <table> <thead> <tr> <th>参数</th> <th>默认值</th> <th>描述</th> </tr> </thead> <tbody> <tr> <td>file</td> <td>ansible.csv</td> <td>要加载的文件名称</td> </tr> <tr> <td>col</td> <td>1</td> <td>要输出的列，索引从0开始</td> </tr> <tr> <td>delimiter</td> <td>TAB</td> <td>文件的分隔符</td> </tr> <tr> <td>default</td> <td>empty string</td> <td>如果key不在csv文件中，则为默认返回值</td> </tr> <tr> <td>encoding</td> <td>utf-8</td> <td>使用的CSV文件的编码（字符集）(added in version 2.1)</td> </tr> </tbody> </table> <h3 id=ini-ini>使用 <code>ini</code> 读取ini文件<a class=headerlink href=#ini-ini title="Permanent link">&para;</a></h3> <p>在section下查找以key1 = value1的格式来读取文件的内容。</p> <div class=highlight><pre><span></span><code><span class=c1># users.ini</span>

<span class=k>[production]</span>
<span class=c1># My production information</span>
<span class=na>user</span><span class=o>=</span><span class=s>robert</span>
<span class=na>pass</span><span class=o>=</span><span class=s>somerandompassword</span>

<span class=k>[integration]</span>
<span class=c1># My  integration information</span>
<span class=na>user</span><span class=o>=</span><span class=s>gertrude</span>
<span class=na>pass</span><span class=o>=</span><span class=s>anotherpassword</span>
</code></pre></div> <div class=highlight><pre><span></span><code><span class=nt>tasks</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">msg=&quot;User in integration is {{  lookup(&#39;ini&#39;, &#39;user section=integration file=users.ini&#39;) }}&quot;</span>

  <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">msg=&quot;User in production  is {{ lookup(&#39;ini&#39;, &#39;pass section=production  file=users.ini&#39;)  }}&quot;</span>
</code></pre></div> <p>ini 参数格式 <div class=highlight><pre><span></span><code><span class="l l-Scalar l-Scalar-Plain">lookup(&#39;ini&#39;,  &#39;key [type=&lt;properties|ini&gt;] [section=section] [file=file.ini] [re=true]  [default=&lt;defaultvalue&gt;]&#39;)</span>
</code></pre></div></p> <p>第一个值必须是ini文件里的key</p> <p>参数描述</p> <table> <thead> <tr> <th>字段</th> <th>默认值</th> <th>描述</th> </tr> </thead> <tbody> <tr> <td>type</td> <td>ini</td> <td>文件类型。 可以是ini或properties （对于javaproperties ）。</td> </tr> <tr> <td>file</td> <td>ansible.ini</td> <td>要加载的文件名称</td> </tr> <tr> <td>section</td> <td>global</td> <td>在哪里查找key</td> </tr> <tr> <td>re</td> <td>False</td> <td>开启正则匹配</td> </tr> <tr> <td>default</td> <td>empty string</td> <td>如果key不在文件中，则为默认返回值</td> </tr> </tbody> </table> <h3 id=dig-dns>使用 <code>dig</code> dns查询<a class=headerlink href=#dig-dns title="Permanent link">&para;</a></h3> <p>此模块依赖 <code>dnspython</code> 库</p> <div class=highlight><pre><span></span><code><span class=nt>tasks</span><span class=p>:</span>
  <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span>  <span class="l l-Scalar l-Scalar-Plain">msg=&quot;The IPv4 address for example.com. is {{ lookup(&#39;dig&#39;,  &#39;example.com.&#39;)}}&quot;</span>

  <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span>  <span class="l l-Scalar l-Scalar-Plain">msg=&quot;The TXT record for example.org. is {{ lookup(&#39;dig&#39;, &#39;example.org.&#39;,  &#39;qtype=TXT&#39;) }}&quot;</span>

  <span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span>  <span class="l l-Scalar l-Scalar-Plain">msg=&quot;The TXT record for example.org. is {{ lookup(&#39;dig&#39;,  &#39;example.org./TXT&#39;) }}&quot;</span>
</code></pre></div> <p>其他插件 <div class=highlight><pre><span></span><code><span class=nt>tasks</span><span class=p>:</span>

<span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">msg=&quot;{{ lookup(&#39;env&#39;,&#39;HOME&#39;) }} is an  environment variable&quot;</span>

<span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">msg=&quot;{{ lookup(&#39;pipe&#39;,&#39;date&#39;) }} is the  raw result of running this command&quot;</span>

<span class=c1># redis_kv lookup requires the  Python redis package</span>
<span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">msg=&quot;{{  lookup(&#39;redis_kv&#39;, &#39;redis://localhost:6379,somekey&#39;) }} is value in Redis for  somekey&quot;</span>

<span class=c1># dnstxt lookup requires the Python  dnspython package</span>
<span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">msg=&quot;{{  lookup(&#39;dnstxt&#39;, &#39;example.com&#39;) }} is a DNS TXT record for example.com&quot;</span>

<span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">msg=&quot;{{ lookup(&#39;template&#39;,  &#39;./some_template.j2&#39;) }} is a value from evaluation of this template&quot;</span>

<span class=c1># loading a json file from a  template as a string</span>
<span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">msg=&quot;{{  lookup(&#39;template&#39;, &#39;./some_json.json.j2&#39;, convert_data=False) }} is a value  from evaluation of this template&quot;</span>

<span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">msg=&quot;{{ lookup(&#39;etcd&#39;, &#39;foo&#39;) }} is a  value from a locally running etcd&quot;</span>

<span class=c1># shelvefile lookup retrieves a  string value corresponding to a key inside a Python shelve file</span>
<span class="p p-Indicator">-</span> <span class=nt>debug</span><span class=p>:</span> <span class="l l-Scalar l-Scalar-Plain">msg=&quot;{{  lookup(&#39;shelvefile&#39;, &#39;file=path_to_some_shelve_file.db key=key_to_retrieve&#39;)  }}</span>
</code></pre></div></p> <hr> <div class=md-source-date> <small> 最后更新: <span class="git-revision-date-localized-plugin git-revision-date-localized-plugin-iso_datetime">2020-12-03 08:40:01</span> </small> </div> <h2 id=__comments>评论</h2> <div id=utteranc-comment></div> <script src=https://utteranc.es/client.js label=utteranc-comment repo=leops-china/ansible-wiki issue-term=pathname theme=github-light crossorigin=anonymous async>
	</script> </article> </div> </div> </main> <footer class=md-footer> <div class=md-footer-nav> <nav class="md-footer-nav__inner md-grid" aria-label=Footer> <a href=../Blocks/ class="md-footer-nav__link md-footer-nav__link--prev" rel=prev> <div class="md-footer-nav__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M20 11v2H8l5.5 5.5-1.42 1.42L4.16 12l7.92-7.92L13.5 5.5 8 11h12z"/></svg> </div> <div class=md-footer-nav__title> <div class=md-ellipsis> <span class=md-footer-nav__direction> 上一页 </span> 14. Blocks </div> </div> </a> <a href=../Reference/Yaml/ class="md-footer-nav__link md-footer-nav__link--next" rel=next> <div class=md-footer-nav__title> <div class=md-ellipsis> <span class=md-footer-nav__direction> 下一页 </span> 1. YAML 语法 </div> </div> <div class="md-footer-nav__button md-icon"> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 24 24"><path d="M4 11v2h12l-5.5 5.5 1.42 1.42L19.84 12l-7.92-7.92L10.5 5.5 16 11H4z"/></svg> </div> </a> </nav> </div> <div class="md-footer-meta md-typeset"> <div class="md-footer-meta__inner md-grid"> <div class=md-footer-copyright> <div class=md-footer-copyright__highlight> Copyright &copy; 2020 - 2020 leops </div> Made with <a href=https://squidfunk.github.io/mkdocs-material/ target=_blank rel=noopener> Material for MkDocs </a> </div> <div class=md-footer-social> <a href=https://github.com/leops-china/ansible-wiki target=_blank rel=noopener title=github.com class=md-footer-social__link> <svg xmlns=http://www.w3.org/2000/svg viewbox="0 0 480 512"><path d="M186.1 328.7c0 20.9-10.9 55.1-36.7 55.1s-36.7-34.2-36.7-55.1 10.9-55.1 36.7-55.1 36.7 34.2 36.7 55.1zM480 278.2c0 31.9-3.2 65.7-17.5 95-37.9 76.6-142.1 74.8-216.7 74.8-75.8 0-186.2 2.7-225.6-74.8-14.6-29-20.2-63.1-20.2-95 0-41.9 13.9-81.5 41.5-113.6-5.2-15.8-7.7-32.4-7.7-48.8 0-21.5 4.9-32.3 14.6-51.8 45.3 0 74.3 9 108.8 36 29-6.9 58.8-10 88.7-10 27 0 54.2 2.9 80.4 9.2 34-26.7 63-35.2 107.8-35.2 9.8 19.5 14.6 30.3 14.6 51.8 0 16.4-2.6 32.7-7.7 48.2 27.5 32.4 39 72.3 39 114.2zm-64.3 50.5c0-43.9-26.7-82.6-73.5-82.6-18.9 0-37 3.4-56 6-14.9 2.3-29.8 3.2-45.1 3.2-15.2 0-30.1-.9-45.1-3.2-18.7-2.6-37-6-56-6-46.8 0-73.5 38.7-73.5 82.6 0 87.8 80.4 101.3 150.4 101.3h48.2c70.3 0 150.6-13.4 150.6-101.3zm-82.6-55.1c-25.8 0-36.7 34.2-36.7 55.1s10.9 55.1 36.7 55.1 36.7-34.2 36.7-55.1-10.9-55.1-36.7-55.1z"/></svg> </a> </div> </div> </div> </footer> </div> <script src=../../assets/javascripts/vendor.7e0ee788.min.js></script> <script src=../../assets/javascripts/bundle.b3a72adc.min.js></script><script id=__lang type=application/json>{"clipboard.copy": "\u590d\u5236", "clipboard.copied": "\u5df2\u590d\u5236", "search.config.lang": "ja", "search.config.pipeline": "trimmer, stemmer", "search.config.separator": "[\\uff0c\\u3002]+", "search.placeholder": "\u641c\u7d22", "search.result.placeholder": "\u952e\u5165\u4ee5\u5f00\u59cb\u641c\u7d22", "search.result.none": "\u6ca1\u6709\u627e\u5230\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.one": "\u627e\u5230 1 \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.other": "# \u4e2a\u7b26\u5408\u6761\u4ef6\u7684\u7ed3\u679c", "search.result.more.one": "1 more on this page", "search.result.more.other": "# more on this page", "search.result.term.missing": "Missing"}</script> <script>
        app = initialize({
          base: "../..",
          features: ['navigation.tabs'],
          search: Object.assign({
            worker: "../../assets/javascripts/worker/search.4ac00218.min.js"
          }, typeof search !== "undefined" && search)
        })
      </script> </body> </html>